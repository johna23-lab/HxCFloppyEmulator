<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>nt4_dev.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>nt4_dev.c</h1><a href="nt4__dev_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00009 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00010 <span class="preprocessor">#include &lt;winioctl.h&gt;</span>
00011 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00012 <span class="preprocessor">#include "nt4_dev.h"</span>
00013 
00014 HANDLE NT4OpenDrive(<span class="keywordtype">char</span> *lpstrDrive)
00015 {
00016     <span class="keywordtype">char</span> strDriveFile[40];
00017     HANDLE hDrv;
00018     DWORD dwRet;
00019 
00020     <span class="keywordflow">switch</span> (lpstrDrive[0]) {
00021         <span class="keywordflow">case</span> <span class="charliteral">'H'</span>:
00022             sprintf(strDriveFile, <span class="stringliteral">"\\\\.\\PhysicalDrive%c"</span>, lpstrDrive[1]);
00023             <span class="keywordflow">break</span>;
00024         <span class="comment">/* add support for other device types here */</span>
00025         <span class="keywordflow">default</span>:
00026             <span class="keywordflow">return</span> NULL;
00027     }
00028 
00029     hDrv = CreateFile(strDriveFile, GENERIC_READ | GENERIC_WRITE,
00030         FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING,
00031         0, NULL);
00032 
00033     <span class="keywordflow">if</span> (hDrv == INVALID_HANDLE_VALUE)
00034         <span class="keywordflow">return</span> NULL;
00035 
00036     <span class="keywordflow">if</span> (! DeviceIoControl(hDrv, FSCTL_LOCK_VOLUME, NULL, 0, NULL, 0,
00037         &amp;dwRet, NULL))
00038         <span class="keywordflow">return</span> NULL;
00039 
00040     <span class="keywordflow">return</span> hDrv;
00041 }
00042 
00043 BOOL NT4CloseDrive(HANDLE hDrv)
00044 {
00045     DWORD dwRet;
00046 
00047     <span class="keywordflow">if</span>( hDrv==NULL ) <span class="keywordflow">return</span> TRUE;                                       <span class="comment">/* BV */</span>
00048 
00049     <span class="keywordflow">if</span> (! DeviceIoControl(hDrv, FSCTL_UNLOCK_VOLUME, NULL, 0, NULL, 0,
00050         &amp;dwRet, NULL))
00051         <span class="keywordflow">return</span> FALSE;
00052 
00053     <span class="keywordflow">if</span> (! CloseHandle(hDrv))
00054         <span class="keywordflow">return</span> FALSE;
00055 
00056     <span class="keywordflow">return</span> TRUE;
00057 }
00058 
00059 BOOL NT4ReadSector(HANDLE hDrv, <span class="keywordtype">long</span> iSect, <span class="keywordtype">int</span> iSize, <span class="keywordtype">void</span> *lpvoidBuf)
00060 {
00061     <span class="keywordtype">void</span> *lpvoidTempBuf;
00062     DWORD dwActual;
00063 
00064     lpvoidTempBuf = VirtualAlloc(NULL, 512, MEM_COMMIT, PAGE_READWRITE);
00065 
00066     <span class="keywordflow">if</span> (SetFilePointer(hDrv, iSect * 512, NULL, FILE_BEGIN) == 0xFFFFFFFF) {
00067         VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00068         <span class="keywordflow">return</span> FALSE;
00069     }
00070 
00071     <span class="keywordflow">if</span> (! ReadFile(hDrv, lpvoidTempBuf, 512, &amp;dwActual, NULL)) {
00072         VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00073         <span class="keywordflow">return</span> FALSE;
00074     }
00075 
00076     memcpy(lpvoidBuf, lpvoidTempBuf, iSize);
00077     VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00078 
00079     <span class="keywordflow">return</span> TRUE;
00080 }
00081 
00082 BOOL NT4WriteSector(HANDLE hDrv, <span class="keywordtype">long</span> iSect, <span class="keywordtype">int</span> iSize, <span class="keywordtype">void</span> *lpvoidBuf)
00083 {
00084     <span class="keywordtype">void</span> *lpvoidTempBuf;
00085     DWORD dwActual;
00086 
00087     <span class="keywordflow">if</span> (iSize != 512)
00088         <span class="keywordflow">return</span> FALSE;
00089 
00090     lpvoidTempBuf = VirtualAlloc(NULL, 512, MEM_COMMIT, PAGE_READWRITE);
00091 
00092     <span class="keywordflow">if</span> (SetFilePointer(hDrv, iSect * 512, NULL, FILE_BEGIN) == 0xFFFFFFFF) {
00093         VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00094         <span class="keywordflow">return</span> FALSE;
00095     }
00096 
00097     memcpy(lpvoidTempBuf, lpvoidBuf, iSize);
00098 
00099     <span class="keywordflow">if</span> (! WriteFile(hDrv, lpvoidTempBuf, 512, &amp;dwActual, NULL)) {
00100         VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00101         <span class="keywordflow">return</span> FALSE;
00102     }
00103     
00104     VirtualFree(lpvoidTempBuf, 0, MEM_RELEASE);
00105 
00106     <span class="keywordflow">return</span> TRUE;
00107 }
00108 
00109 ULONG NT4GetDriveSize(HANDLE hDrv)
00110 {
00111     DWORD dwActual;
00112     DISK_GEOMETRY dgGeom;
00113     <span class="keywordtype">long</span> size;
00114 
00115     DeviceIoControl(hDrv, IOCTL_DISK_GET_DRIVE_GEOMETRY, NULL, 0,
00116         &amp;dgGeom, <span class="keyword">sizeof</span>(DISK_GEOMETRY), &amp;dwActual, NULL);
00117 
00118     size =  dgGeom.Cylinders.LowPart * dgGeom.TracksPerCylinder *
00119         dgGeom.SectorsPerTrack * dgGeom.BytesPerSector;
00120 <span class="comment">/* BV */</span>
00121 <span class="comment">/*  printf("Total sectors: %i\n", dgGeom.Cylinders.LowPart * dgGeom.TracksPerCylinder * dgGeom.SectorsPerTrack);</span>
00122 <span class="comment">**  printf("Byte size: %i\n", size);</span>
00123 <span class="comment">*/</span>
00124     <span class="keywordflow">return</span> size;
00125 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:42 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
