<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>New.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>New.c</h1><a href="_new_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ADF Opus Copyright 1998-2002 by </span>
00002 <span class="comment"> * Dan Sutherland &lt;dan@chromerhino.demon.co.uk&gt; and Gary Harris &lt;gharris@zip.com.au&gt;.   </span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> */</span>
00011 <span class="preprocessor">#include "Pch.h"</span>
00012 
00013 <span class="preprocessor">#include "ADFOpus.h"</span>
00014 <span class="preprocessor">#include "ADFlib.h"</span>
00015 <span class="preprocessor">#include "New.h"</span>
00016 <span class="preprocessor">#include "Options.h"</span>
00017 <span class="preprocessor">#include "ChildCommon.h"</span>
00018 <span class="preprocessor">#include "Help\AdfOpusHlp.h"</span>
00019 <span class="preprocessor">#include "Install.h"</span>
00020 
00021 <span class="keyword">extern</span> <span class="keywordtype">char</span> gstrFileName[MAX_PATH * 2];
00022 <span class="keyword">extern</span> HINSTANCE instance;
00023 <span class="keyword">extern</span> HWND ghwndFrame;
00024 <span class="keyword">extern</span> HWND ghwndMDIClient;
00025 
00026 <span class="comment">/* globals */</span>
00027 <span class="keyword">extern</span> <span class="keywordtype">int</span> Done;
00028 HWND NewProgress;
00029 <span class="keywordtype">long</span> Size;
00030 <span class="keyword">extern</span> <span class="keywordtype">int</span> Percent;
00031 <span class="keyword">extern</span> UINT Timer;
00032 <span class="keyword">extern</span> <span class="keyword">struct </span>OPTIONS Options;
00033 
00034 <span class="comment">/* prototypes */</span>
00035 <span class="keywordtype">void</span> NewCreate(HWND);
00036 <span class="keywordtype">void</span> NewSelectFile(HWND);
00037 LRESULT CALLBACK NewProgressProc(HWND, UINT, WPARAM, LPARAM);
00038 <span class="keywordtype">void</span> NewCreateFile(<span class="keywordtype">void</span> *);
00039 
00040 LRESULT CALLBACK NewDlgProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00041 {
00042     <span class="keywordtype">char</span> size[6];
00043     <span class="keywordtype">int</span> newPos;
00044 
00045     <span class="keyword">static</span> DWORD aIds[] = { 
00046         IDC_NEWPATH,            IDH_CREATE_PATH_EDIT,
00047         IDC_NEWBROWSE,          IDH_CREATE_PATH_BROWSE, 
00048         IDC_NEWADF,             IDH_CREATE_TYPE_ADF,    
00049         IDC_NEWHD,              IDH_CREATE_TYPE_HD,
00050         IDC_NEWHARDFILE,        IDH_CREATE_TYPE_HARDFILE,
00051         IDC_NEWPRESET,          IDH_CREATE_TYPE_HARDFILE_PRESET,
00052         IDC_NEWPRESETSLIDER,    IDH_CREATE_TYPE_HARDFILE_PRESET_SIZES,
00053         IDC_NEWCUSTOM,          IDH_CREATE_TYPE_HARDFILE_CUSTOM,
00054         IDC_NEWCUSTOMSIZE,      IDH_CREATE_TYPE_HARDFILE_CUSTOM_SIZE,
00055         IDC_NEWFFS,             IDH_CREATE_FILESYSTEM_FFS,
00056         IDC_NEWDIRC,            IDH_CREATE_FILESYSTEM_DC,
00057         IDC_NEWINTL,            IDH_CREATE_FILESYSTEM_IFS,
00058         IDC_NEWBOOTABLE,        IDH_CREATE_FILESYSTEM_BOOT,
00059         IDC_NEWLABEL,           IDH_CREATE_LABEL,
00060         IDC_NEWOPEN,            IDH_CREATE_OPEN,
00061         IDC_NEWCREATE,          IDH_CREATE_CREATE_BUTTON,
00062         IDC_NEWHELP,            IDH_CREATE_HELP_BUTTON,
00063         IDCANCEL,               IDH_CREATE_CANCEL_BUTTON,
00064         0,0 
00065     };  
00066 
00067     
00068     <span class="keywordflow">switch</span>(msg) {
00069     <span class="keywordflow">case</span> WM_INITDIALOG:
00070         SendMessage(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), TBM_SETRANGE, TRUE, MAKELONG(0, 9));
00071         SendMessage(GetDlgItem(dlg, IDC_NEWADF), BM_SETCHECK, BST_CHECKED, 0l);
00072         SendMessage(GetDlgItem(dlg, IDC_NEWPRESET), BM_SETCHECK, BST_CHECKED, 0l);
00073         SendMessage(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), BM_SETCHECK, BST_CHECKED, 0l);
00074         SendMessage(GetDlgItem(dlg, IDC_NEWPRESETSIZE), BM_SETCHECK, BST_CHECKED, 0l);
00075         SetDlgItemText(dlg, IDC_NEWPATH, <span class="stringliteral">"NEW.ADF"</span>);
00076         SetDlgItemText(dlg, IDC_NEWLABEL, Options.defaultLabel);
00077         <span class="keywordflow">return</span> TRUE;
00078     <span class="keywordflow">case</span> WM_COMMAND:
00079         <span class="keywordflow">switch</span>(wp) {
00080         <span class="keywordflow">case</span> IDC_NEWCREATE:
00081             NewCreate(dlg);
00082             <span class="keywordflow">return</span> TRUE;
00083         <span class="keywordflow">case</span> IDCANCEL:
00084             EndDialog(dlg, TRUE);
00085             <span class="keywordflow">return</span> TRUE;
00086         <span class="keywordflow">case</span> IDC_NEWBROWSE:
00087             NewSelectFile(dlg);
00088             <span class="keywordflow">return</span> TRUE;
00089         <span class="keywordflow">case</span> IDC_NEWADF:
00090             EnableWindow(GetDlgItem(dlg, IDC_NEWHD), TRUE);
00091             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESET), FALSE);
00092             EnableWindow(GetDlgItem(dlg, IDC_NEWCUSTOM), FALSE);
00093             EnableWindow(GetDlgItem(dlg, IDC_NEWCUSTOMSIZE), FALSE);
00094             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSIZE), FALSE);
00095             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), FALSE);
00096             EnableWindow(GetDlgItem(dlg, IDC_NEWBOOTABLE), TRUE);
00097             <span class="keywordflow">return</span> TRUE;
00098         <span class="keywordflow">case</span> IDC_NEWHARDFILE:
00099             EnableWindow(GetDlgItem(dlg, IDC_NEWHD), FALSE);
00100             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESET), TRUE);
00101             EnableWindow(GetDlgItem(dlg, IDC_NEWCUSTOM), TRUE);
00102             EnableWindow(GetDlgItem(dlg, IDC_NEWBOOTABLE), FALSE);
00103             <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWPRESET), BM_GETCHECK, 0, 0l) == BST_CHECKED)
00104                 SendMessage(dlg, WM_COMMAND, IDC_NEWPRESET, 0l);
00105             <span class="keywordflow">else</span>
00106                 SendMessage(dlg, WM_COMMAND, IDC_NEWCUSTOM, 0l);
00107             <span class="keywordflow">return</span> TRUE;
00108         <span class="keywordflow">case</span> IDC_NEWPRESET:
00109             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSIZE), TRUE);
00110             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), TRUE);
00111             EnableWindow(GetDlgItem(dlg, IDC_NEWCUSTOMSIZE), FALSE);
00112             <span class="keywordflow">return</span> TRUE;
00113         <span class="keywordflow">case</span> IDC_NEWCUSTOM:
00114             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSIZE), FALSE);
00115             EnableWindow(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), FALSE);
00116             EnableWindow(GetDlgItem(dlg, IDC_NEWCUSTOMSIZE), TRUE);
00117             <span class="keywordflow">return</span> TRUE;
00118         <span class="keywordflow">case</span> IDC_NEWDIRC:
00119             <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWDIRC), BM_GETCHECK, 0, 0l) == BST_CHECKED) {
00120                 SendMessage(GetDlgItem(dlg, IDC_NEWINTL), BM_SETCHECK, TRUE, 0l);
00121                 EnableWindow(GetDlgItem(dlg, IDC_NEWINTL), FALSE);
00122             }<span class="keywordflow">else</span>
00123                 EnableWindow(GetDlgItem(dlg, IDC_NEWINTL), TRUE);
00124             <span class="keywordflow">return</span> TRUE;
00125 
00126         <span class="keywordflow">case</span> IDC_NEWHELP:
00127             <span class="comment">// Implement help button.</span>
00128             WinHelp(dlg, <span class="stringliteral">"ADFOpus.hlp&gt;Opus_win"</span>, HELP_CONTEXT, IDH_CREATE_DIALOGUE);
00129             <span class="keywordflow">return</span> TRUE;
00130 
00131         }
00132         <span class="keywordflow">break</span>;
00133     <span class="keywordflow">case</span> WM_CLOSE:
00134         EndDialog(dlg, TRUE);
00135         <span class="keywordflow">return</span> TRUE;
00136     <span class="keywordflow">case</span> WM_HSCROLL:
00137     <span class="keywordflow">case</span> TB_LINEDOWN:
00138     <span class="keywordflow">case</span> TB_LINEUP:
00139         newPos = SendMessage(GetDlgItem(dlg, IDC_NEWPRESETSLIDER), TBM_GETPOS, 0, 0l);
00140         itoa(1 &lt;&lt; newPos, size, 10);
00141         strcat(size, <span class="stringliteral">"MB"</span>);
00142         SetWindowText(GetDlgItem(dlg, IDC_NEWPRESETSIZE), size);
00143         <span class="keywordflow">return</span> TRUE;
00144 
00145         <span class="comment">// Context sensitive help.</span>
00146     <span class="keywordflow">case</span> WM_HELP: 
00147         WinHelp(((LPHELPINFO) lp)-&gt;hItemHandle, <span class="stringliteral">"adfopus.hlp"</span>, 
00148             HELP_WM_HELP, (DWORD) (LPSTR) aIds); 
00149         <span class="keywordflow">break</span>; 
00150  
00151     <span class="keywordflow">case</span> WM_CONTEXTMENU: 
00152         WinHelp((HWND) wp, <span class="stringliteral">"adfopus.hlp"</span>, HELP_CONTEXTMENU, 
00153             (DWORD) (LPVOID) aIds); 
00154         <span class="keywordflow">break</span>;  
00155 
00156     }
00157     <span class="keywordflow">return</span> FALSE;
00158 }
00159 
00160 <span class="keywordtype">void</span> NewCreate(HWND dlg)
00161 {
00162     <span class="keywordtype">int</span> iType;
00163     <span class="keywordtype">char</span> ts[30];
00164 
00165     <span class="comment">/* determine size of file to create (in SECTORS) */</span>
00166     iType = SendMessage(GetDlgItem(dlg, IDC_NEWADF), BM_GETCHECK, 0, 0l);
00167     <span class="keywordflow">if</span> (iType == BST_CHECKED) {
00168         <span class="comment">/* it is a adf file */</span>
00169         Size = (SendMessage(GetDlgItem(dlg, IDC_NEWHD), BM_GETCHECK, 0, 0l)
00170             == BST_CHECKED) ? 1760 &lt;&lt; 1 : 1760;     
00171     } <span class="keywordflow">else</span> {
00172         <span class="comment">/* hardfile */</span>
00173         <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWPRESET), BM_GETCHECK, 0, 0l)
00174             == BST_CHECKED) {
00175             <span class="comment">/* one of the preset sizes */</span>
00176             Size = (2 &lt;&lt; SendMessage(GetDlgItem(dlg, IDC_NEWPRESETSLIDER),
00177                 TBM_GETPOS, 0, 0l)) * 1024;
00178         } <span class="keywordflow">else</span> {
00179             <span class="comment">/* custom size */</span>
00180             GetDlgItemText(dlg, IDC_NEWCUSTOMSIZE, ts, <span class="keyword">sizeof</span>(ts));
00181             Size = atol(ts) &lt;&lt; 1;
00182         }
00183     }
00184 
00185     <span class="keywordflow">if</span> (! Size) {
00186         MessageBox(dlg, <span class="stringliteral">"The custom size you specified is not valid"</span>,
00187             <span class="stringliteral">"Error"</span>, MB_OK | MB_ICONERROR);
00188         <span class="keywordflow">return</span>;
00189     }
00190 
00191     <span class="comment">/* create the file */</span>
00192     GetDlgItemText(dlg, IDC_NEWPATH, gstrFileName, <span class="keyword">sizeof</span>(gstrFileName));
00193     Done = FALSE;
00194 
00195     <span class="comment">/* display the create progress dialogue */</span>
00196     _beginthread(NewCreateFile, 0, dlg);
00197     DialogBox(instance, MAKEINTRESOURCE(IDD_PROGRESS1), dlg, (DLGPROC)NewProgressProc);
00198     SendMessage(dlg, WM_COMMAND, IDCANCEL, 0l);
00199     <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWOPEN), BM_GETCHECK, 0, 0l) == BST_CHECKED)
00200             <a class="code" href="_child_common_8c.html#a46">CreateChildWin</a>(ghwndMDIClient, CHILD_AMILISTER);
00201 }
00202 
00203 <span class="keywordtype">void</span> NewSelectFile(HWND dlg)
00204 {
00205     OPENFILENAME ofn;
00206 
00207     strcpy(gstrFileName, <span class="stringliteral">""</span>);
00208 
00209     ofn.lStructSize = <span class="keyword">sizeof</span>(OPENFILENAME);
00210     ofn.hwndOwner = dlg;
00211     ofn.hInstance = NULL;
00212     ofn.lpstrFilter = <span class="stringliteral">"Amiga Disk File (*.adf)\0*.adf\0Hard Disk File (*.hdf)\0*.hdf\0Any file\0*.*\0"</span>;
00213     ofn.lpstrCustomFilter = NULL;
00214     ofn.nMaxCustFilter = 0;
00215     ofn.lpstrFile = gstrFileName;
00216     ofn.nMaxFile = <span class="keyword">sizeof</span>(gstrFileName);
00217     ofn.lpstrFileTitle = NULL;
00218     ofn.lpstrInitialDir = NULL;
00219     ofn.lpstrTitle = <span class="stringliteral">"Save disk image"</span>;
00220     ofn.Flags = OFN_SHAREAWARE | OFN_HIDEREADONLY | OFN_OVERWRITEPROMPT;
00221     ofn.lpstrDefExt = NULL;
00222 
00223     <span class="keywordflow">if</span> (GetSaveFileName(&amp;ofn)) {
00224         SetDlgItemText(dlg, IDC_NEWPATH, gstrFileName);
00225     }
00226 }
00227 
00228 LRESULT CALLBACK NewProgressProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00229 {
00230     <span class="keywordflow">switch</span> (msg) {
00231     <span class="keywordflow">case</span> WM_INITDIALOG:
00232         Timer = SetTimer(dlg, 1, 100, NULL);
00233         <span class="keywordflow">return</span> TRUE;
00234     <span class="keywordflow">case</span> WM_COMMAND:
00235         <span class="keywordflow">switch</span> (wp) {
00236         <span class="keywordflow">case</span> IDCANCEL:
00237             Done = TRUE;
00238             <span class="keywordflow">return</span> TRUE;
00239         }
00240     <span class="keywordflow">case</span> WM_TIMER:
00241         <span class="keywordflow">if</span> (Done) {
00242             KillTimer(dlg, Timer);
00243             EndDialog(dlg, TRUE);
00244         }
00245         SendMessage(GetDlgItem(dlg, IDC_CREATEPROGRESS), PBM_SETPOS, Percent, 0l);
00246         <span class="keywordflow">return</span> TRUE;
00247     }
00248 
00249     <span class="keywordflow">return</span> FALSE;
00250 }
00251 
00252 <span class="keywordtype">void</span> NewCreateFile(<span class="keywordtype">void</span> *lpVoid)
00253 {
00254     <span class="keyword">struct </span>Device   *dev;
00255     <span class="keywordtype">char</span>            tempStr[31];
00256     HWND            dlg = (HWND)lpVoid;
00257     <span class="keywordtype">int</span>             type = 0;
00258     <span class="keyword">struct </span>Volume   *vol;
00259 
00260     Percent = 0;
00261 
00262     <span class="keywordflow">if</span> (Size == 1760) <span class="comment">/* 880KB Floppy */</span>
00263         dev = adfCreateDumpDevice(gstrFileName, 80, 2, 11);
00264     <span class="keywordflow">else</span>
00265         <span class="keywordflow">if</span> (Size == (1760 * 2)) <span class="comment">/* HD Floppy */</span>
00266             dev = adfCreateDumpDevice(gstrFileName, 80, 2, 22);
00267         <span class="keywordflow">else</span> <span class="comment">/* hardfile */</span>
00268             dev = adfCreateDumpDevice(gstrFileName, Size, 1, 1);
00269 
00270     GetDlgItemText(dlg, IDC_NEWLABEL, tempStr, <span class="keyword">sizeof</span>(tempStr));
00271 
00272     <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWFFS), BM_GETCHECK, 0, 0l) == BST_CHECKED)
00273         type += FSMASK_FFS;
00274     <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWINTL), BM_GETCHECK, 0, 0l) == BST_CHECKED)
00275         type += FSMASK_INTL;
00276     <span class="keywordflow">if</span> (SendMessage(GetDlgItem(dlg, IDC_NEWDIRC), BM_GETCHECK, 0, 0l) == BST_CHECKED)
00277         type += FSMASK_DIRCACHE;
00278     
00279     <span class="keywordflow">if</span> ((Size == 1760) || (Size == 1760 * 2)){
00280         adfCreateFlop(dev, tempStr, type);
00281         <span class="comment">// Install bootblock if "Bootable" selected.</span>
00282         <span class="keywordflow">if</span>(SendMessage(GetDlgItem(dlg, IDC_NEWBOOTABLE), BM_GETCHECK, 0, 0l) == BST_CHECKED){
00283             vol = adfMount(dev, 0, FALSE);
00284             InstallBootBlock(dlg, vol);
00285         }
00286     }
00287     <span class="keywordflow">else</span>
00288         adfCreateHdFile(dev, tempStr, type);
00289 
00290     adfUnMountDev(dev);
00291 
00292     Done = TRUE;
00293 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:42 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
