<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>fdi.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>fdi.c</h1><a href="fdi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * ADF Opus Copyright 1998-2002 by </span>
00003 <span class="comment"> * Dan Sutherland &lt;dan@chromerhino.demon.co.uk&gt; and Gary Harris &lt;gharris@zip.com.au&gt;.   </span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * This code by Gary Harris.</span>
00007 <span class="comment"> */</span>
00015 <span class="comment">//    Functions used to implement Disk2FDI functionality.</span>
00016 <span class="comment">//</span>
00017 
00018 
00019 <span class="preprocessor">#include "Pch.h"</span>
00020 
00021 <span class="preprocessor">#include "ADFOpus.h"</span>
00022 <span class="preprocessor">#include "ChildCommon.h"</span>
00023 <span class="preprocessor">#include "Help\AdfOpusHlp.h"</span>
00024 <span class="preprocessor">#include "fdi.h"</span>
00025 <span class="preprocessor">#include &lt;direct.h&gt;</span>
00026 
00027 <span class="keyword">extern</span> <span class="keywordtype">char</span> gstrFileName[MAX_PATH * 2];
00028 <span class="keyword">extern</span> HWND ghwndMDIClient;
00029 
00030 
00031 
00032 LRESULT CALLBACK Disk2FDIProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00033 {
00034 
00035     <span class="keyword">static</span> DWORD aIds[] = { 
00036         IDC_EDIT_FILENAME,      IDH_DISK2FDI_FILENAME,
00037         IDC_CHECK_OPEN,         IDH_DISK2FDI_CHECK_OPEN,
00038         IDC_RADIO_FDI,          IDH_DISK2FDI_TYPE_FDI,  
00039         IDC_RADIO_ADF,          IDH_DISK2FDI_TYPE_ADF,  
00040         IDC_RADIO_ST,           IDH_DISK2FDI_TYPE_ST,
00041         IDC_RADIO_IMG,          IDH_DISK2FDI_TYPE_IMG,
00042         IDC_CHECK_USE_B_DRIVE,  IDH_DISK2FDI_USE_B,
00043         IDC_RADIO_SINGLE_SIDED, IDH_DISK2FDI_1SIDED,
00044         IDC_RADIO_DOUBLE_SIDED, IDH_DISK2FDI_2SIDED,
00045         IDC_CHECK_TRACKS,       IDH_DISK2FDI_NUM_TRACKS,
00046         IDC_EDIT_TRACKS,        IDH_DISK2FDI_NUM_TRACKS,
00047         IDC_CHECK_SECTORS,      IDH_DISK2FDI_NUM_SECTORS,
00048         IDC_EDIT_SECTORS,       IDH_DISK2FDI_NUM_SECTORS,
00049         IDSTART,                IDH_DISK2FDI_START_BUTTON,
00050         IDC_BUTTON_FDI_HELP,    IDH_DISK2FDI_HELP_BUTTON,
00051         IDCANCEL,               IDH_DISK2FDI_CANCEL_BUTTON,
00052         0,0 
00053     };  
00054 
00055 
00056     <span class="keywordflow">switch</span>(msg) {
00057     <span class="keywordflow">case</span> WM_INITDIALOG:
00058 
00059         SendDlgItemMessage(dlg, IDC_RADIO_ADF, BM_SETCHECK, BST_CHECKED, 0l);
00060         SendDlgItemMessage(dlg, IDC_RADIO_DOUBLE_SIDED, BM_SETCHECK, BST_CHECKED, 0l);
00061         
00062         <span class="comment">// Set the spin control ranges.</span>
00063         SendDlgItemMessage(dlg, IDC_SPIN_TRACKS, UDM_SETRANGE, 0L, MAKELONG(87, 1));    <span class="comment">// 1 - 87 tracks.</span>
00064         SendDlgItemMessage(dlg, IDC_SPIN_SECTORS, UDM_SETRANGE, 0L, MAKELONG(64, 1));   <span class="comment">// 1 - 64 sectors.</span>
00065         <span class="comment">// Set the spin control default values.</span>
00066         SendDlgItemMessage(dlg, IDC_SPIN_TRACKS, UDM_SETPOS, 0L, MAKELONG((SHORT)80, 0));   <span class="comment">// Default to 80 tracks.</span>
00067         SendDlgItemMessage(dlg, IDC_SPIN_SECTORS, UDM_SETPOS, 0L, MAKELONG((SHORT)22, 0));  <span class="comment">// Default to 22 sectors.</span>
00068 
00069         <span class="keywordflow">return</span> TRUE;
00070     <span class="keywordflow">case</span> WM_COMMAND:
00071         <span class="keywordflow">switch</span>((int)LOWORD(wp)) {
00072 
00073             <span class="keywordflow">case</span> IDC_RADIO_FDI:
00074                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_SECTORS), FALSE);
00075                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_TRACKS), TRUE);
00076                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_OPEN), FALSE);       <span class="comment">// Disable opening in Opus.</span>
00077                 <span class="keywordflow">return</span> TRUE;
00078 
00079             <span class="keywordflow">case</span> IDC_RADIO_ADF:
00080                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_SECTORS), FALSE);
00081                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_TRACKS), FALSE);
00082                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_OPEN), TRUE);        <span class="comment">// Enable opening in Opus.</span>
00083                 <span class="keywordflow">return</span> TRUE;
00084             
00085             <span class="keywordflow">case</span> IDC_RADIO_ST:
00086             <span class="keywordflow">case</span> IDC_RADIO_IMG:
00087                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_SECTORS), TRUE);
00088                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_TRACKS), TRUE);
00089                 EnableWindow(GetDlgItem(dlg, IDC_CHECK_OPEN), FALSE);       <span class="comment">// Disable opening in Opus.</span>
00090                 <span class="keywordflow">return</span> TRUE;
00091         
00092             <span class="keywordflow">case</span> IDC_CHECK_TRACKS:
00093                 <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_TRACKS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00094                     EnableWindow(GetDlgItem(dlg, IDC_EDIT_TRACKS), TRUE);
00095                     EnableWindow(GetDlgItem(dlg, IDC_SPIN_TRACKS), TRUE);
00096                 }
00097                 <span class="keywordflow">else</span>{
00098                     EnableWindow(GetDlgItem(dlg, IDC_EDIT_TRACKS), FALSE);
00099                     EnableWindow(GetDlgItem(dlg, IDC_SPIN_TRACKS), FALSE);
00100                 }
00101                 <span class="keywordflow">return</span> TRUE;
00102 
00103             <span class="keywordflow">case</span> IDC_CHECK_SECTORS:
00104                 <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_SECTORS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00105                     EnableWindow(GetDlgItem(dlg, IDC_EDIT_SECTORS), TRUE);
00106                     EnableWindow(GetDlgItem(dlg, IDC_SPIN_SECTORS), TRUE);
00107                 }
00108                 <span class="keywordflow">else</span>{
00109                     EnableWindow(GetDlgItem(dlg, IDC_EDIT_SECTORS), FALSE);
00110                     EnableWindow(GetDlgItem(dlg, IDC_SPIN_SECTORS), FALSE);
00111                 }
00112                 <span class="keywordflow">return</span> TRUE;
00113 
00114             <span class="keywordflow">case</span> IDSTART:
00115                 <a class="code" href="fdi_8c.html#a3">RunDisk2FDI</a>(dlg);
00116                 <span class="keywordflow">return</span> TRUE;
00117 
00118             <span class="keywordflow">case</span> IDCANCEL:
00119                 EndDialog(dlg, TRUE);
00120                 <span class="keywordflow">return</span> TRUE;
00121 
00122             <span class="keywordflow">case</span> IDC_BUTTON_FDI_HELP:
00123                 <span class="comment">// Implement help button.</span>
00124                 WinHelp(dlg, <span class="stringliteral">"ADFOpus.hlp&gt;Opus_win"</span>, HELP_CONTEXT, IDH_DISK2FDI);
00125                 <span class="keywordflow">return</span> TRUE;
00126 
00127         }
00128         <span class="keywordflow">break</span>;
00129 
00130     <span class="keywordflow">case</span> WM_CLOSE:
00131         EndDialog(dlg, TRUE);
00132         <span class="keywordflow">return</span> TRUE;
00133 
00134     <span class="comment">// Context sensitive help.</span>
00135     <span class="keywordflow">case</span> WM_HELP: 
00136        WinHelp(((LPHELPINFO) lp)-&gt;hItemHandle, <span class="stringliteral">"adfopus.hlp"</span>, HELP_WM_HELP, (DWORD) (LPSTR) aIds); 
00137         <span class="keywordflow">break</span>; 
00138  
00139     <span class="keywordflow">case</span> WM_CONTEXTMENU: 
00140         WinHelp((HWND) wp, <span class="stringliteral">"adfopus.hlp"</span>, HELP_CONTEXTMENU, (DWORD) (LPVOID) aIds); 
00141         <span class="keywordflow">break</span>;  
00142 
00143     }
00144     <span class="keywordflow">return</span> FALSE;
00145 }
00146 
00147 
<a name="l00148"></a><a class="code" href="fdi_8c.html#a3">00148</a> <span class="keywordtype">void</span> <a class="code" href="fdi_8c.html#a3">RunDisk2FDI</a>(HWND dlg)
00152 {
00153     <span class="keywordtype">char</span>    *szCommand = <span class="stringliteral">"DISK2FDI.COM"</span>;            <span class="comment">// Command.</span>
00154     <span class="keywordtype">char</span>    *szTracksArg = <span class="stringliteral">"/T"</span>;
00155     <span class="keywordtype">char</span>    *szHeadsArg = <span class="stringliteral">"/H"</span>;
00156     <span class="keywordtype">char</span>    *szSectorArg = <span class="stringliteral">"/S"</span>;
00157     <span class="keywordtype">char</span>    *szDriveArg = <span class="stringliteral">"B:"</span>;
00158         
00159     <span class="keywordtype">char</span>    szFileName[MAX_PATH];                   <span class="comment">// Dump name.</span>
00160     <span class="keywordtype">char</span>    szCommandLine[MAX_PATH + 26];           <span class="comment">// Final command line - max name length + 26 for args.</span>
00161     <span class="keywordtype">char</span>    szCommandLineArgs[MAX_PATH + 26];       <span class="comment">// Final command line - max name length + 26 for args.</span>
00162     <span class="keywordtype">char</span>    szNumTracks[3];
00163     <span class="keywordtype">char</span>    szNumSectors[3];
00164     <span class="keywordtype">char</span>    fileName[MAX_PATH];
00165     <span class="keywordtype">char</span>    drive[MAX_PATH];
00166     BOOL    bIsADF = FALSE;
00167     STARTUPINFO s_info;
00168     PROCESS_INFORMATION p_info;
00169     HANDLE hProc;
00170 
00171     sprintf(szCommandLineArgs, <span class="stringliteral">" "</span>);    <span class="comment">// Print a space to avoid errors copying an unintialised string later.</span>
00172 
00173     <span class="comment">// Number of heads.</span>
00174     <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_RADIO_SINGLE_SIDED, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00175         sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s1 "</span>, szCommandLineArgs, szHeadsArg);
00176     }
00177     
00178     <span class="comment">// Sector dump.</span>
00179     <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_RADIO_ADF, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00180         sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s "</span>, szCommandLineArgs, szSectorArg);
00181         bIsADF = TRUE;
00182     }
00183     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_RADIO_FDI, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00184         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_TRACKS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00185             SendDlgItemMessage(dlg, IDC_EDIT_TRACKS, WM_GETTEXT, 3, (LPARAM)szNumTracks);     <span class="comment">// check for 2 digits????????</span>
00186             sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s%s "</span>, szCommandLineArgs, szTracksArg, szNumTracks);
00187         }
00188     }
00189     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_RADIO_IMG, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00190         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_TRACKS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00191             SendDlgItemMessage(dlg, IDC_EDIT_TRACKS, WM_GETTEXT, 3, (LPARAM)szNumTracks);
00192             sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s%s "</span>, szCommandLineArgs, szTracksArg, szNumTracks);
00193         }
00194         sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s "</span>, szCommandLineArgs, szSectorArg);
00195         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_SECTORS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00196             SendDlgItemMessage(dlg, IDC_EDIT_SECTORS, WM_GETTEXT, 3, (LPARAM)szNumSectors);
00197             sprintf(szCommandLineArgs, <span class="stringliteral">"%s%s "</span>, szCommandLineArgs, szNumSectors);
00198         }
00199     }
00200     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_RADIO_ST, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00201         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_TRACKS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00202             SendDlgItemMessage(dlg, IDC_EDIT_TRACKS, WM_GETTEXT, 3, (LPARAM)szNumTracks);
00203             sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s%s "</span>, szCommandLineArgs, szTracksArg, szNumTracks);
00204         }
00205         sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s "</span>, szCommandLineArgs, szSectorArg);
00206         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_SECTORS, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00207             SendDlgItemMessage(dlg, IDC_EDIT_SECTORS, WM_GETTEXT, 3, (LPARAM)szNumSectors);
00208             sprintf(szCommandLineArgs, <span class="stringliteral">"%s%s "</span>, szCommandLineArgs, szNumSectors);
00209         }
00210 
00211     }
00212 
00213     <span class="comment">// Number of heads.</span>
00214     <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_USE_B_DRIVE, BM_GETCHECK, 0L, 0L) == BST_CHECKED ){
00215         sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s "</span>, szCommandLineArgs, szDriveArg);
00216     }
00217     
00218     SendDlgItemMessage(dlg, IDC_EDIT_FILENAME, WM_GETTEXT, MAX_PATH, (LPARAM)szFileName);   <span class="comment">// Get filename.</span>
00219     sprintf(szCommandLineArgs, <span class="stringliteral">"%s %s"</span>, szCommandLineArgs, szFileName);
00220 
00221     _splitpath(szFileName, drive, NULL, fileName, NULL);    <span class="comment">// Get filename.</span>
00222     <span class="keywordflow">if</span>(strcmp(drive, <span class="stringliteral">""</span>) == 0){
00223         _getcwd(drive, MAX_PATH);
00224         strcat(drive, <span class="stringliteral">"\\"</span>);
00225         strcat(fileName, <span class="stringliteral">".adf"</span>);
00226         strcat(drive, fileName);
00227         strcpy(gstrFileName, drive);
00228     }
00229 
00230     sprintf(szCommandLine, <span class="stringliteral">"%s%s"</span>, szCommand, szCommandLineArgs);
00231     memset(&amp;s_info, 0, <span class="keyword">sizeof</span>(s_info));
00232     s_info.cb = <span class="keyword">sizeof</span>(s_info);
00233     <span class="keywordflow">if</span>(!CreateProcess(NULL, szCommandLine, NULL, NULL, FALSE, 0, NULL, NULL, &amp;s_info, &amp;p_info)){
00234         MessageBox(dlg,
00235                    <span class="stringliteral">"Disk2FDI was not found in the command path. See help for further details."</span>,
00236                    <span class="stringliteral">"ADF Opus Error"</span>,
00237                    MB_ICONSTOP);
00238         <span class="keywordflow">return</span>;
00239     }
00240 
00241     <span class="comment">// If opening after creation, wait for the process.</span>
00242     <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_CHECK_OPEN, BM_GETCHECK, 0, 0L) == BST_CHECKED &amp;&amp; bIsADF){
00243         hProc = OpenProcess(SYNCHRONIZE, FALSE, p_info.dwProcessId);
00244         WaitForSingleObject(hProc, INFINITE);
00245         CloseHandle(hProc);
00246         EndDialog(dlg, TRUE);
00247         <a class="code" href="_child_common_8c.html#a46">CreateChildWin</a>(ghwndMDIClient, CHILD_AMILISTER);
00248     }
00249     <span class="keywordflow">return</span>;
00250 }
00251 
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:40 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
