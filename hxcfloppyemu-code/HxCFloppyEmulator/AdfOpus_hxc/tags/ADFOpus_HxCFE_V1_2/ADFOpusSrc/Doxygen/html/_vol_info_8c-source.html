<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>VolInfo.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>VolInfo.c</h1><a href="_vol_info_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ADF Opus Copyright 1998-2002 by </span>
00002 <span class="comment"> * Dan Sutherland &lt;dan@chromerhino.demon.co.uk&gt; and Gary Harris &lt;gharris@zip.com.au&gt;.   </span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> */</span>
00011 <span class="preprocessor">#include "Pch.h"</span>
00012 
00013 <span class="preprocessor">#include "Utils.h"</span>
00014 <span class="preprocessor">#include "ADFOpus.h"</span>
00015 <span class="preprocessor">#include "ChildCommon.h"</span>
00016 <span class="preprocessor">#include "ADF_raw.h"</span> <span class="comment">/* we shouldn't really be using this */</span>
00017 <span class="preprocessor">#include "ADF_Bitm.h"</span> <span class="comment">/* or this */</span>
00018 <span class="preprocessor">#include "ADF_Nativ.h"</span> <span class="comment">/* or this */</span>
00019 <span class="preprocessor">#include "VolInfo.h"</span>
00020 <span class="preprocessor">#include "ListView.h"</span>
00021 <span class="preprocessor">#include "Help\AdfOpusHlp.h"</span>
00022 
00023 <span class="comment">/* local prototypes */</span>
00024 <span class="keywordtype">void</span> VolInfoInit(HWND, HWND);
00025 LRESULT CALLBACK VolInfoDlgProc(HWND, UINT, WPARAM, LPARAM);
00026 <span class="keywordtype">void</span> VolInfoOnSelChanged(HWND);
00027 <span class="keywordtype">void</span> VolInfoKill(HWND, HWND);
00028 LRESULT CALLBACK VolInfoChildDlgProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp);
00029 
00030 <span class="comment">/* globals */</span>
00031 HWND tabControl;
00032 <span class="keywordtype">int</span> curPage = 0;
00033 HWND pages[2];
00034 
00035 <span class="keyword">extern</span> HINSTANCE instance;
00036 <span class="keyword">extern</span> HWND ghwndMDIClient;
00037 <span class="keyword">extern</span> <span class="keywordtype">char</span> gstrFileName[MAX_PATH * 2];
00038 
00039 LRESULT CALLBACK VolInfoDlgProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00040 {
00041     LPNMHDR nmhdr;
00042 
00043     <span class="keyword">static</span> DWORD aIds[] = {
00044         IDC_STATIC_PATH,        IDH_INFO_DEV_PATH,
00045         IDC_DEVPATH,            IDH_INFO_DEV_PATH,
00046         IDC_STATIC_SIZE,        IDH_INFO_DEV_SIZE,
00047         IDC_DEVSIZE,            IDH_INFO_DEV_SIZE,
00048         IDC_STATIC_TYPE,        IDH_INFO_DEV_TYPE,
00049         IDC_DEVTYPE,            IDH_INFO_DEV_TYPE,  
00050         IDC_STATIC_CYLINDERS,   IDH_INFO_DEV_GEOMETRY,
00051         IDC_DEVCYLINDERS,       IDH_INFO_DEV_GEOMETRY,
00052         IDC_STATIC_HEADS,       IDH_INFO_DEV_GEOMETRY,
00053         IDC_DEVHEADS,           IDH_INFO_DEV_GEOMETRY,
00054         IDC_STATIC_SECTORS,     IDH_INFO_DEV_GEOMETRY,
00055         IDC_DEVSECT,            IDH_INFO_DEV_GEOMETRY,
00056         IDC_DEVVOLLIST,         IDH_INFO_DEV_VOLUMES,
00057         IDC_VOLLABEL,           IDH_INFO_VOL_LABEL,
00058         IDC_VOLUSED,            IDH_INFO_VOL_USED,
00059         IDC_VOLFULLGAUGE,       IDH_INFO_VOL_USED,
00060         IDC_VOLFREE,            IDH_INFO_VOL_FREE,
00061         IDC_VOLTOTAL,           IDH_INFO_VOL_TOTAL,
00062         IDC_VOLFULL,            IDH_INFO_VOL_FULL,
00063         IDC_VOLFFS,             IDH_INFO_VOL_FFS,
00064         IDC_VOLDIRC,            IDH_INFO_VOL_DC,
00065         IDC_VOLINTL,            IDH_INFO_VOL_INTL,
00066         IDC_VOLINFO_HELP,       IDH_INFO_HELP_BUTTON,
00067         IDCANCEL,               IDH_INFO_CLOSE_BUTTON,
00068         0,0 
00069     };  
00070     
00071     <span class="keywordflow">switch</span>(msg) {
00072     <span class="keywordflow">case</span> WM_INITDIALOG:
00073         tabControl = GetDlgItem(dlg, IDC_VOLINFOTABCTRL);       
00074         VolInfoInit(dlg, tabControl);
00075         <span class="keywordflow">return</span> TRUE;
00076     <span class="keywordflow">case</span> WM_COMMAND:
00077         <span class="keywordflow">switch</span>(wp) {
00078         <span class="keywordflow">case</span> IDCANCEL:
00079             VolInfoKill(dlg, tabControl);
00080             <span class="keywordflow">return</span> TRUE;
00081 
00082         <span class="keywordflow">case</span> IDC_VOLINFO_HELP:
00083             <span class="comment">// Implement help button.</span>
00084             WinHelp(dlg, <span class="stringliteral">"ADFOpus.hlp&gt;Opus_win"</span>, HELP_CONTEXT, IDH_INFORMATION_DIALOGUE_DEV);
00085             <span class="keywordflow">return</span> TRUE;
00086 
00087         }
00088         <span class="keywordflow">break</span>;
00089     <span class="keywordflow">case</span> WM_NOTIFY:
00090         nmhdr = (NMHDR *)lp;
00091         <span class="keywordflow">switch</span>(nmhdr-&gt;code) {
00092         <span class="keywordflow">case</span> TCN_SELCHANGE:
00093             VolInfoOnSelChanged(dlg);
00094             <span class="keywordflow">return</span> TRUE;
00095         }
00096         <span class="keywordflow">break</span>;
00097     <span class="keywordflow">case</span> WM_CLOSE:
00098         VolInfoKill(dlg, tabControl);
00099         <span class="keywordflow">return</span> TRUE;
00100 
00101         <span class="comment">// Context sensitive help.</span>
00102     <span class="keywordflow">case</span> WM_HELP: 
00103         WinHelp(((LPHELPINFO) lp)-&gt;hItemHandle, <span class="stringliteral">"adfopus.hlp"</span>, 
00104             HELP_WM_HELP, (DWORD) (LPSTR) aIds); 
00105         <span class="keywordflow">break</span>; 
00106  
00107     <span class="keywordflow">case</span> WM_CONTEXTMENU: 
00108         WinHelp((HWND) wp, <span class="stringliteral">"adfopus.hlp"</span>, HELP_CONTEXTMENU, 
00109             (DWORD) (LPVOID) aIds); 
00110         <span class="keywordflow">break</span>;  
00111     }
00112     <span class="keywordflow">return</span> FALSE;
00113 }
00114 
00115 <span class="keywordtype">void</span> VolInfoInit(HWND dlg, HWND tc)
00116 <span class="comment">/* set up the dialogue, create tabs and show the first page</span>
00117 <span class="comment"> */</span>
00118 {
00119     TC_ITEM tie;
00120     RECT rTC;
00121     <span class="keywordtype">int</span> i;
00122     HWND ac;
00123     CHILDINFO *ci;
00124     <span class="keywordtype">char</span> tempStr[50], buf[50];
00125     <span class="keyword">struct </span>bRootBlock root;
00126     <span class="keywordtype">int</span> percent;
00127     <span class="keyword">struct </span>nativeDevice *nd;
00128 
00129     tie.mask = TCIF_TEXT | TCIF_IMAGE;
00130     tie.iImage = -1;
00131     tie.pszText = <span class="stringliteral">"Device"</span>;
00132     TabCtrl_InsertItem(tc, 0, &amp;tie);
00133     tie.pszText = <span class="stringliteral">"Volume"</span>;
00134     TabCtrl_InsertItem(tc, 1, &amp;tie);
00135 
00136     pages[0] = CreateDialog(instance, MAKEINTRESOURCE(IDD_VOLINFOPAGE1), tc, VolInfoChildDlgProc);
00137     pages[1] = CreateDialog(instance, MAKEINTRESOURCE(IDD_VOLINFOPAGE2), tc, VolInfoChildDlgProc);
00138 
00139     GetClientRect(tc, &amp;rTC);
00140     TabCtrl_AdjustRect(tc, FALSE, &amp;rTC);
00141 
00142     <span class="keywordflow">for</span> (i = 0 ; i &lt; 2 ; i++) {
00143         MoveWindow(pages[i], rTC.left, rTC.top, rTC.right - rTC.left, rTC.bottom - rTC.top, FALSE);
00144     }
00145 
00146     ac = (HWND)SendMessage(ghwndMDIClient, WM_MDIGETACTIVE, 0, (LPARAM) NULL);
00147     ci = (CHILDINFO *)GetWindowLong(ac, 0);
00148 
00149     <span class="comment">/* device info */</span>
00150     nd = (<span class="keyword">struct </span>nativeDevice *)ci-&gt;dev-&gt;nativeDev;
00151 
00152     SetDlgItemText(pages[0], IDC_DEVPATH, ci-&gt;orig_path);
00153 
00154     <span class="keywordflow">switch</span> (ci-&gt;dev-&gt;devType) {
00155     <span class="keywordflow">case</span> DEVTYPE_FLOPDD:
00156         strcpy(tempStr, <span class="stringliteral">"Double Density Floppy (880KB ADF)"</span>);
00157         <span class="keywordflow">break</span>;
00158     <span class="keywordflow">case</span> DEVTYPE_FLOPHD:
00159         strcpy(tempStr, <span class="stringliteral">"High Density Floppy (1760KB ADF)"</span>);
00160         <span class="keywordflow">break</span>;
00161     <span class="keywordflow">case</span> DEVTYPE_HARDDISK:
00162         strcpy(tempStr, <span class="stringliteral">"Hard disk dump"</span>);
00163         <span class="keywordflow">break</span>;
00164     <span class="keywordflow">case</span> DEVTYPE_HARDFILE:
00165         strcpy(tempStr, <span class="stringliteral">"Hardfile"</span>);
00166         <span class="keywordflow">break</span>;
00167     <span class="keywordflow">default</span>:
00168         strcpy(tempStr, <span class="stringliteral">"Unknown (!)"</span>);
00169     }   
00170 
00171     <span class="comment">// Prefix compression type to type string.</span>
00172     <span class="keywordflow">if</span>(ci-&gt;dfDisk == ADZ){
00173         strcpy(buf, tempStr);
00174         strcpy(tempStr, <span class="stringliteral">"Compressed "</span>);
00175         strcat(tempStr, buf);
00176     }
00177     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ci-&gt;dfDisk == DMS){
00178         strcpy(buf, tempStr);
00179         strcpy(tempStr, <span class="stringliteral">"Diskmashed "</span>);
00180         strcat(tempStr, buf);
00181     }
00182     
00183     SetDlgItemText(pages[0], IDC_DEVTYPE, tempStr);
00184 
00185     <span class="keywordflow">if</span>(ci-&gt;dfDisk == ADF){
00186         SizeToStr(ci-&gt;dev-&gt;size, tempStr);
00187         SetDlgItemText(pages[0], IDC_DEVSIZE, tempStr);     <span class="comment">// ADF size.</span>
00188     }
00189     <span class="keywordflow">else</span>{
00190         _itoa(ci-&gt;compSize/1024, tempStr, 10);              <span class="comment">// Convert to string and KB.</span>
00191         strcat(tempStr, <span class="stringliteral">"KB"</span>);
00192         SetDlgItemText(pages[0], IDC_DEVSIZE, tempStr);     <span class="comment">// Compressed disk size.</span>
00193     }
00194     
00195     itoa(ci-&gt;dev-&gt;cylinders, tempStr, 10);
00196     SetDlgItemText(pages[0], IDC_DEVCYLINDERS, tempStr);
00197     itoa(ci-&gt;dev-&gt;heads, tempStr, 10);
00198     SetDlgItemText(pages[0], IDC_DEVHEADS, tempStr);
00199     itoa(ci-&gt;dev-&gt;sectors, tempStr, 10);
00200     SetDlgItemText(pages[0], IDC_DEVSECT, tempStr);
00201 
00202     <span class="comment">/* fill volume list */</span>
00203     LVAddColumn(GetDlgItem(pages[0], IDC_DEVVOLLIST), <span class="stringliteral">"ID"</span>, 30, 0);
00204     LVAddColumn(GetDlgItem(pages[0], IDC_DEVVOLLIST), <span class="stringliteral">"Name"</span>, 100, 1);
00205     LVAddColumn(GetDlgItem(pages[0], IDC_DEVVOLLIST), <span class="stringliteral">"Start"</span>, 70, 2);
00206     LVAddColumn(GetDlgItem(pages[0], IDC_DEVVOLLIST), <span class="stringliteral">"End"</span>, 70, 3);
00207 
00208     <span class="keywordflow">for</span> (i = 0 ; i &lt; ci-&gt;dev-&gt;nVol ; i++) {
00209         itoa(i, tempStr, 10);
00210         LVAddItem(GetDlgItem(pages[0], IDC_DEVVOLLIST), tempStr, 1);
00211             <span class="keywordflow">if</span> (ci-&gt;dev-&gt;volList[i]-&gt;volName)
00212             strcpy(tempStr, ci-&gt;dev-&gt;volList[i]-&gt;volName);
00213         <span class="keywordflow">else</span>
00214             strcpy(tempStr, <span class="stringliteral">"-"</span>);
00215 
00216         LVAddSubItem(GetDlgItem(pages[0], IDC_DEVVOLLIST), tempStr, i, 1);
00217         itoa(ci-&gt;dev-&gt;volList[i]-&gt;firstBlock, tempStr, 10);
00218         LVAddSubItem(GetDlgItem(pages[0], IDC_DEVVOLLIST), tempStr, i, 2);
00219         itoa(ci-&gt;dev-&gt;volList[i]-&gt;lastBlock, tempStr, 10);
00220         LVAddSubItem(GetDlgItem(pages[0], IDC_DEVVOLLIST), tempStr, i, 3);
00221     }
00222 
00223     <span class="comment">/* volume info */</span>
00224     adfReadRootBlock(ci-&gt;vol, ci-&gt;vol-&gt;rootBlock, &amp;root);
00225     memset(tempStr, 0, <span class="keyword">sizeof</span>(tempStr));
00226     memcpy(tempStr, root.diskName, root.nameLen);
00227     SetDlgItemText(pages[1], IDC_VOLLABEL, tempStr);
00228 
00229     SizeToStr((ci-&gt;vol-&gt;lastBlock + 1 - ci-&gt;vol-&gt;firstBlock) * LOGICAL_BLOCK_SIZE, tempStr);
00230     SetDlgItemText(pages[1], IDC_VOLTOTAL, tempStr);
00231     SizeToStr(((ci-&gt;vol-&gt;lastBlock + 1 - ci-&gt;vol-&gt;firstBlock) - adfCountFreeBlocks(ci-&gt;vol)) * LOGICAL_BLOCK_SIZE, tempStr);
00232     SetDlgItemText(pages[1], IDC_VOLUSED, tempStr);
00233     SizeToStr((adfCountFreeBlocks(ci-&gt;vol)) * LOGICAL_BLOCK_SIZE, tempStr);
00234     SetDlgItemText(pages[1], IDC_VOLFREE, tempStr);
00235     percent = (((ci-&gt;vol-&gt;lastBlock + 1 - ci-&gt;vol-&gt;firstBlock) -
00236         adfCountFreeBlocks(ci-&gt;vol)) * 100) /
00237         (ci-&gt;vol-&gt;lastBlock + 1 - ci-&gt;vol-&gt;firstBlock);
00238     itoa(percent, tempStr, 10);
00239     strcat(tempStr, <span class="stringliteral">"%"</span>);
00240     SetDlgItemText(pages[1], IDC_VOLFULL, tempStr);
00241 
00242     <span class="comment">/* DOS type */</span>
00243     SetDlgItemText(pages[1], IDC_VOLFFS, isFFS(ci-&gt;vol-&gt;dosType) ? <span class="stringliteral">"YES"</span> : <span class="stringliteral">"NO"</span>);
00244     SetDlgItemText(pages[1], IDC_VOLINTL, isINTL(ci-&gt;vol-&gt;dosType) ? <span class="stringliteral">"YES"</span> : <span class="stringliteral">"NO"</span>);
00245     SetDlgItemText(pages[1], IDC_VOLDIRC, isDIRCACHE(ci-&gt;vol-&gt;dosType) ? <span class="stringliteral">"YES"</span> : <span class="stringliteral">"NO"</span>);
00246 
00247     SendMessage(GetDlgItem(pages[1], IDC_VOLFULLGAUGE), PBM_SETPOS, percent, 0l);
00248 
00249     curPage = 0;
00250     ShowWindow(pages[curPage], SW_SHOW);
00251 }
00252 
00253 <span class="keywordtype">void</span> VolInfoOnSelChanged(HWND dlg)
00254 <span class="comment">/* hide the currently shown page and display a replacement</span>
00255 <span class="comment"> */</span>
00256 { 
00257     ShowWindow(pages[curPage], SW_HIDE);
00258 
00259     curPage = TabCtrl_GetCurSel(tabControl);
00260 
00261     ShowWindow(pages[curPage], SW_SHOW);
00262 }
00263 
00264 LRESULT CALLBACK VolInfoChildDlgProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00265 <span class="comment">/* none of the child windows do anything, so we give them this token proc</span>
00266 <span class="comment"> */</span>
00267 {
00268     <span class="keywordflow">return</span> FALSE;
00269 }
00270 
00271 <span class="keywordtype">void</span> VolInfoKill(HWND dlg, HWND tc)
00272 <span class="comment">/* destroy the child windows and quit</span>
00273 <span class="comment"> */</span>
00274 {
00275     DestroyWindow(pages[0]);
00276     DestroyWindow(pages[1]);
00277     EndDialog(dlg, TRUE);
00278 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:43 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
