<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Options.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>Options.c</h1><a href="_options_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ADF Opus Copyright 1998-2002 by </span>
00002 <span class="comment"> * Dan Sutherland &lt;dan@chromerhino.demon.co.uk&gt; and Gary Harris &lt;gharris@zip.com.au&gt;.   </span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> */</span>
00011 <span class="preprocessor">#include "Pch.h"</span>
00012 
00013 <span class="preprocessor">#include "ADFOpus.h"</span>
00014 <span class="preprocessor">#include "Utils.h"</span>
00015 <span class="preprocessor">#include "Options.h"</span>
00016 <span class="preprocessor">#include "ADFlib.h"</span>
00017 <span class="preprocessor">#include "Help\AdfOpusHlp.h"</span>
00018 <span class="preprocessor">#include "ShellOpen.h"</span>
00019 
00020 <span class="comment">/* local prototypes */</span>
00021 <span class="keywordtype">void</span> WriteOptions();
00022 <span class="keywordtype">void</span> ApplyOptions(HWND);
00023 <span class="keywordtype">void</span> SetDefaultOptions();
00024 <span class="keywordtype">void</span> OptionsChanged(HWND);
00025 
00026 <span class="keyword">extern</span> HANDLE ghInstance;
00027 <span class="keyword">extern</span> <span class="keyword">struct </span>OPTIONS Options;
00028 <span class="keyword">extern</span> HWND ghwndFrame;
00029 <span class="keyword">extern</span> <span class="keyword">struct </span>Env adfEnv; <span class="comment">/* this should not be here - Laurent's fault */</span>
00030 
00031 LRESULT CALLBACK OptionsProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00032 {
00033     <span class="keyword">static</span> DWORD aIds[] = { 
00034         IDC_ODRIVELIST, IDH_OPTIONS_WINLIST_DRIVE,
00035         IDC_OTHISDIR,   IDH_OPTIONS_WINLIST_DIR,    
00036         IDC_ODIR,       IDH_OPTIONS_DIR,    
00037         IDC_OLABEL,     IDH_OPTIONS_LABEL,
00038         IDC_ODELETE,    IDH_OPTIONS_CONFIRM_COMDEL,
00039         IDC_ODELDIR,    IDH_OPTIONS_CONFIRM_DELDIR,
00040         IDC_ODIRCACHE,  IDH_OPTIONS_MISC_DIRCACHE,
00041         IDC_OREGISTER,  IDH_OPTIONS_REGISTER_BUTTON,
00042         IDC_OOK,        IDH_OPTIONS_OK_BUTTON,
00043         IDC_OAPPLY,     IDH_OPTIONS_APPLY_BUTTON,
00044         IDC_OHELP,      IDH_OPTIONS_HELP_BUTTON,
00045         IDCANCEL,       IDH_OPTIONS_CANCEL_BUTTON,
00046         0,0 
00047     };  
00048 
00049     
00050     <span class="keywordflow">switch</span>(msg) {
00051     <span class="keywordflow">case</span> WM_INITDIALOG:
00052         SetDlgItemText(dlg, IDC_OLABEL, Options.defaultLabel);
00053         SetDlgItemText(dlg, IDC_ODIR, Options.defaultDir);
00054         SendMessage(GetDlgItem(dlg, IDC_ODIRCACHE), BM_SETCHECK, (Options.useDirCache ? BST_CHECKED : 0), 0l);
00055         SendMessage(GetDlgItem(dlg, IDC_ODELETE), BM_SETCHECK, (Options.confirmDelete ? BST_CHECKED : 0), 0l);
00056         SendMessage(GetDlgItem(dlg, IDC_ODELDIR), BM_SETCHECK, (Options.confirmDeleteDirs ? BST_CHECKED : 0), 0l);
00057         SendMessage(GetDlgItem(dlg, Options.defDriveList ? IDC_ODRIVELIST : IDC_OTHISDIR), BM_SETCHECK, BST_CHECKED, 0l);
00058         
00059         EnableWindow(GetDlgItem(dlg, IDC_ODIR), ! Options.defDriveList);
00060         <span class="keywordflow">return</span> TRUE;
00061     <span class="keywordflow">case</span> WM_COMMAND:
00062         <span class="keywordflow">switch</span>((int)LOWORD(wp)) {
00063         <span class="keywordflow">case</span> IDC_ODELETE:
00064         <span class="keywordflow">case</span> IDC_ODELDIR:
00065         <span class="keywordflow">case</span> IDC_ODIRCACHE:
00066         <span class="keywordflow">case</span> IDC_ODIR:
00067         <span class="keywordflow">case</span> IDC_OLABEL:
00068             OptionsChanged(dlg);
00069             <span class="keywordflow">return</span> TRUE;
00070         <span class="keywordflow">case</span> IDC_ODRIVELIST:
00071             EnableWindow(GetDlgItem(dlg, IDC_ODIR), FALSE);
00072             OptionsChanged(dlg);
00073             <span class="keywordflow">return</span> TRUE;
00074         <span class="keywordflow">case</span> IDC_OTHISDIR:
00075             EnableWindow(GetDlgItem(dlg, IDC_ODIR), TRUE);
00076             OptionsChanged(dlg);
00077             <span class="keywordflow">return</span> TRUE;
00078         <span class="keywordflow">case</span> IDC_OOK:
00079             ApplyOptions(dlg);
00080         <span class="keywordflow">case</span> IDCANCEL:
00081             EndDialog(dlg, TRUE);
00082             <span class="keywordflow">return</span> TRUE;
00083         <span class="keywordflow">case</span> IDC_OAPPLY:
00084             ApplyOptions(dlg);
00085             SetDlgItemText(dlg, IDCANCEL, <span class="stringliteral">"Close"</span>);
00086             EnableWindow(GetDlgItem(dlg, IDC_OAPPLY), FALSE);
00087             <span class="keywordflow">return</span> TRUE;
00088 
00089         <span class="keywordflow">case</span> IDC_OREGISTER:
00090             RegisterFileTypes();        <span class="comment">// Register .adf file types.</span>
00091             <span class="keywordflow">return</span> TRUE;
00092 
00093         <span class="keywordflow">case</span> IDC_OHELP:
00094             <span class="comment">// Implement help button.</span>
00095             WinHelp(dlg, <span class="stringliteral">"ADFOpus.hlp&gt;Opus_win"</span>, HELP_CONTEXT, IDH_OPTIONS);
00096             <span class="keywordflow">return</span> TRUE;
00097 
00098         }
00099         <span class="keywordflow">break</span>;
00100     <span class="keywordflow">case</span> WM_CLOSE:
00101         EndDialog(dlg, TRUE);
00102         <span class="keywordflow">return</span> TRUE;
00103 
00104     <span class="comment">// Context sensitive help.</span>
00105     <span class="keywordflow">case</span> WM_HELP: 
00106         WinHelp(((LPHELPINFO) lp)-&gt;hItemHandle, <span class="stringliteral">"adfopus.hlp"</span>, 
00107             HELP_WM_HELP, (DWORD) (LPSTR) aIds); 
00108         <span class="keywordflow">break</span>; 
00109  
00110     <span class="keywordflow">case</span> WM_CONTEXTMENU: 
00111         WinHelp((HWND) wp, <span class="stringliteral">"adfopus.hlp"</span>, HELP_CONTEXTMENU, 
00112             (DWORD) (LPVOID) aIds); 
00113         <span class="keywordflow">break</span>;  
00114 
00115     }
00116     <span class="keywordflow">return</span> FALSE;
00117 }
00118 
00119 <span class="keywordtype">void</span> SetDefaultOptions()
00120 {
00121     Options.confirmDelete = TRUE;
00122     Options.confirmDeleteDirs = TRUE;
00123     strcpy(Options.defaultDir, <span class="stringliteral">"C:\\"</span>);
00124     strcpy(Options.defaultLabel, <span class="stringliteral">"ADF Opus Created Me!"</span>);
00125     Options.useDirCache = TRUE;
00126     Options.defDriveList = FALSE;
00127 }
00128 
00129 <span class="keywordtype">void</span> ReadOptions()
00130 {
00131     HKEY key;
00132     DWORD type, size;
00133 
00134     <span class="keywordflow">if</span> (RegOpenKeyEx(HKEY_CURRENT_USER, <span class="stringliteral">"Software\\ADFOpus"</span>, 0, KEY_READ, &amp;key)
00135         == ERROR_SUCCESS) {
00136         <span class="comment">/* read into struct options */</span>
00137         size = <span class="keyword">sizeof</span>(Options);
00138         <span class="keywordflow">if</span> (RegQueryValueEx(key, <span class="stringliteral">"Settings"</span>, 0L, &amp;type, (<span class="keywordtype">void</span> *)&amp;Options, &amp;size) != ERROR_SUCCESS) {
00139             MessageBox(NULL, <span class="stringliteral">"An error occured reading settings from the registry. Possibly the"</span>
00140                 <span class="stringliteral">" registry has been corrupted or modified. Using default settings."</span>, <span class="stringliteral">"ADF Opus - Error"</span>, MB_OK |
00141                 MB_ICONERROR);
00142             SetDefaultOptions();
00143         }
00144     } <span class="keywordflow">else</span> {
00145         MessageBox(NULL, <span class="stringliteral">"It seems this is the first time you have run ADF Opus. Now is a good time"</span>
00146             <span class="stringliteral">" to remind you that this program comes with ABSOLUTELY NO WARRANTY. See the Readme and"</span>
00147             <span class="stringliteral">" license files for more information.\n\n"</span>
00148             <span class="stringliteral">"I hope you enjoy this program, if you have any comments please email them to me (see"</span>
00149             <span class="stringliteral">" Help | About for contact details."</span>,
00150             <span class="stringliteral">"Welcome to ADF Opus"</span>, MB_OK | MB_ICONINFORMATION);
00151         SetDefaultOptions();
00152         RegisterFileTypes();        <span class="comment">// Register Amiga disk file types.</span>
00153     }
00154 }
00155 
00156 <span class="keywordtype">void</span> WriteOptions()
00157 {
00158     HKEY key;
00159     DWORD disp;
00160 
00161     <span class="keywordflow">if</span> (RegCreateKeyEx(HKEY_CURRENT_USER, <span class="stringliteral">"Software\\ADFOpus"</span>, 0, <span class="stringliteral">""</span>,
00162     REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &amp;key, &amp;disp) == ERROR_SUCCESS) {
00163         RegSetValueEx(key, <span class="stringliteral">"Settings"</span>, 0, REG_BINARY, (<span class="keywordtype">void</span> *)&amp;Options, <span class="keyword">sizeof</span>(Options));
00164     } <span class="keywordflow">else</span> {
00165         MessageBox(NULL, <span class="stringliteral">"An error occured writing user preferences to the registry."</span>, <span class="stringliteral">"ADF Opus: Error"</span>,
00166             MB_OK | MB_ICONERROR);
00167     }
00168 }
00169 
00170 <span class="keywordtype">void</span> ApplyOptions(HWND dlg)
00171 {
00172     GetDlgItemText(dlg, IDC_OLABEL, Options.defaultLabel, <span class="keyword">sizeof</span>(Options.defaultLabel));
00173     GetDlgItemText(dlg, IDC_ODIR, Options.defaultDir, <span class="keyword">sizeof</span>(Options.defaultDir));
00174     <span class="keywordflow">if</span> (Options.defaultDir[strlen(Options.defaultDir) - 1] != <span class="charliteral">'\\'</span>)
00175         strcat (Options.defaultDir, <span class="stringliteral">"\\"</span>);
00176 
00177 
00178     Options.useDirCache = (SendMessage(GetDlgItem(dlg, IDC_ODIRCACHE), BM_GETCHECK, 0, 0l) == BST_CHECKED);
00179     Options.confirmDelete = (SendMessage(GetDlgItem(dlg, IDC_ODELETE), BM_GETCHECK, 0, 0l) == BST_CHECKED);
00180     Options.confirmDeleteDirs = (SendMessage(GetDlgItem(dlg, IDC_ODELDIR), BM_GETCHECK, 0, 0l) == BST_CHECKED);
00181     Options.defDriveList = (SendMessage(GetDlgItem(dlg, IDC_ODRIVELIST), BM_GETCHECK, 0, 0l) == BST_CHECKED);
00182 
00183     adfEnv.useDirCache = Options.useDirCache;
00184 }
00185 
00186 <span class="keywordtype">void</span> OptionsChanged(HWND dlg)
00187 {
00188     SetDlgItemText(dlg, IDCANCEL, <span class="stringliteral">"Cancel"</span>);
00189     EnableWindow(GetDlgItem(dlg, IDC_OAPPLY), TRUE);
00190 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:42 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
