<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BatchConvert.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>BatchConvert.c</h1><a href="_batch_convert_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ADF Opus Copyright 1998-2002 by </span>
00002 <span class="comment"> * Dan Sutherland &lt;dan@chromerhino.demon.co.uk&gt; and Gary Harris &lt;gharris@zip.com.au&gt;.   </span>
00003 <span class="comment"> *</span>
00004 <span class="comment"> */</span>
00011 <span class="preprocessor">#include "Pch.h"</span>
00012 
00013 <span class="preprocessor">#include "ADFOpus.h"</span>
00014 <span class="preprocessor">#include "Xdms.h"</span>
00015 <span class="preprocessor">#include "Utils.h"</span>
00016 <span class="preprocessor">#include "BatchConvert.h"</span>
00017 <span class="preprocessor">#include "zLib.h"</span>
00018 <span class="preprocessor">#include "Help\AdfOpusHlp.h"</span>
00019 
00020 <span class="preprocessor">#define BUFLEN      16384</span>
00021 <span class="preprocessor"></span>
00022 <span class="keyword">extern</span> HANDLE ghInstance;
00023 <span class="keywordtype">char</span>   strOFNFileNames[MAX_PATH * 10];
00024 <span class="keyword">extern</span> HWND ghwndFrame;
00025 
00026 
00027 <span class="comment">//extern void dmsErrMsg(USHORT, char *, char *, char *);</span>
00028 
00029 LRESULT CALLBACK BatchConvertProc(HWND dlg, UINT msg, WPARAM wp, LPARAM lp)
00030 {
00031     <span class="keyword">static</span> DWORD aIds[] = { 
00032         IDC_BCFILELIST,         IDH_BATCH_SOURCE_LIST,
00033         IDC_BCADD,              IDH_BATCH_ADD_BUTTON,   
00034         IDC_BCREMOVE,           IDH_BATCH_REMOVE_BUTTON,    
00035         IDC_BCREMOVEALL,        IDH_BATCH_REMOVE_ALL_BUTTON,
00036         IDC_BCDELETE_ORIGINAL,  IDH_BATCH_DELETE_ORIGINAL,
00037         IDC_BCADF,              IDH_BATCH_ADF_BUTTON,
00038         IDC_BCADZ,              IDH_BATCH_ADZ_BUTTON,
00039         IDC_BCSTATUS,           IDH_BATCH_STATUS,   
00040         IDC_BCSTART,            IDH_BATCH_START_BUTTON,
00041         IDC_BCHELP,             IDH_BATCH_HELP_BUTTON,
00042         IDCANCEL,               IDH_BATCH_CLOSE_BUTTON,
00043         0,0 
00044     };  
00045 
00046     
00047     <span class="keywordflow">switch</span>(msg) {
00048     <span class="keywordflow">case</span> WM_INITDIALOG:
00049         SendMessage(GetDlgItem(dlg, IDC_BCADF), BM_SETCHECK, BST_CHECKED, 0l);
00050         BCUpdateButtons(dlg);
00051         <span class="keywordflow">return</span> TRUE;
00052     <span class="keywordflow">case</span> WM_COMMAND:
00053         <span class="keywordflow">switch</span>((int)LOWORD(wp)) {
00054         <span class="keywordflow">case</span> IDC_BCADD:
00055             BCAddFiles(dlg);
00056             <span class="keywordflow">return</span> TRUE;
00057         <span class="keywordflow">case</span> IDC_BCSTART:
00058             BCConvert(dlg);
00059             <span class="keywordflow">return</span> TRUE;
00060         <span class="keywordflow">case</span> IDC_BCFILELIST:
00061             BCUpdateButtons(dlg);
00062             <span class="keywordflow">return</span> TRUE;
00063         <span class="keywordflow">case</span> IDC_BCREMOVE:
00064             BCDeleteSelected(dlg);
00065             <span class="keywordflow">return</span> TRUE;
00066         <span class="keywordflow">case</span> IDC_BCREMOVEALL:
00067             BCDeleteAll(dlg);
00068             <span class="comment">// Re-enable output buttons if all names are removed.</span>
00069             SendMessage(GetDlgItem(dlg, IDC_BCADF), BM_SETCHECK, BST_CHECKED, 0);
00070             SendMessage(GetDlgItem(dlg, IDC_BCADZ), BM_SETCHECK, BST_UNCHECKED, 0);
00071             EnableWindow(GetDlgItem(dlg, IDC_BCADF), TRUE);
00072             EnableWindow(GetDlgItem(dlg, IDC_BCADZ), TRUE);
00073 
00074             <span class="keywordflow">return</span> TRUE;
00075 
00076         <span class="keywordflow">case</span> IDC_BCHELP:
00077             <span class="comment">// Implement help button.</span>
00078             WinHelp(dlg, <span class="stringliteral">"ADFOpus.hlp&gt;Opus_win"</span>, HELP_CONTEXT, IDH_BATCH_CONVERTER);
00079             <span class="keywordflow">return</span> TRUE;
00080 
00081         <span class="keywordflow">case</span> IDCANCEL:
00082             EndDialog(dlg, TRUE);
00083             iFileTypeSelected = 0;          <span class="comment">// Reset file type so output buttons are reset.</span>
00084             <span class="keywordflow">return</span> TRUE;
00085         }
00086         <span class="keywordflow">break</span>;
00087     <span class="keywordflow">case</span> WM_CLOSE:
00088         EndDialog(dlg, TRUE);
00089         iFileTypeSelected = 0;              <span class="comment">// Reset file type so output buttons are reset.</span>
00090         <span class="keywordflow">return</span> TRUE;
00091 
00092     <span class="comment">// Context sensitive help.</span>
00093     <span class="keywordflow">case</span> WM_HELP: 
00094         WinHelp(((LPHELPINFO) lp)-&gt;hItemHandle, <span class="stringliteral">"adfopus.hlp"</span>, 
00095             HELP_WM_HELP, (DWORD) (LPSTR) aIds); 
00096         <span class="keywordflow">break</span>; 
00097  
00098     <span class="keywordflow">case</span> WM_CONTEXTMENU: 
00099         WinHelp((HWND) wp, <span class="stringliteral">"adfopus.hlp"</span>, HELP_CONTEXTMENU, 
00100             (DWORD) (LPVOID) aIds); 
00101         <span class="keywordflow">break</span>;  
00102 
00103     }
00104     <span class="keywordflow">return</span> FALSE;
00105 }
00106 
00107 <span class="keywordtype">void</span> BCAddFiles(HWND dlg)
00108 <span class="comment">// Open files dialogue.</span>
00109 {
00110     OPENFILENAME ofn;
00111     HWND lb = GetDlgItem(dlg, IDC_BCFILELIST);
00112     <span class="keywordtype">int</span> i, no;
00113     <span class="keywordtype">char</span> ts[MAX_PATH];
00114 
00115     strcpy(strOFNFileNames, <span class="stringliteral">""</span>);
00116     <span class="comment">// Set up OPENFILENAME structure.</span>
00117     ofn.lStructSize = <span class="keyword">sizeof</span>(OPENFILENAME);
00118     ofn.hwndOwner = dlg;
00119     ofn.hInstance = NULL;
00120     <span class="comment">// Filter indices are adf:1, dms:2, adz:3.</span>
00121     ofn.lpstrFilter = <span class="stringliteral">"Amiga Disk Files (*.adf)\0*.adf\0Compressed Disk Files (*.adz)\0*.adz\0Diskmasher Files (*.dms)\0*.dms\0\0"</span>;
00122     ofn.lpstrCustomFilter = NULL;
00123     ofn.nMaxCustFilter = 0;
00124     ofn.lpstrFile = strOFNFileNames;
00125     ofn.nMaxFile = <span class="keyword">sizeof</span>(strOFNFileNames);
00126     ofn.lpstrFileTitle = NULL;
00127     ofn.lpstrInitialDir = NULL;
00128     ofn.lpstrTitle = <span class="stringliteral">"Open disk image"</span>;
00129     ofn.Flags = OFN_FILEMUSTEXIST | OFN_PATHMUSTEXIST | OFN_SHAREAWARE |
00130         OFN_ALLOWMULTISELECT | OFN_HIDEREADONLY | OFN_EXPLORER;
00131     ofn.lpstrDefExt = NULL;
00132 
00133     <span class="keywordflow">if</span> (! GetOpenFileName(&amp;ofn))
00134         <span class="keywordflow">return</span>;
00135 
00136     no = CountOFNFiles(strOFNFileNames, <span class="keyword">sizeof</span>(strOFNFileNames));
00137     <span class="keywordflow">if</span> (no == 1)
00138         SendMessage(lb, LB_ADDSTRING, 0, (LPARAM)&amp;strOFNFileNames);
00139     <span class="keywordflow">else</span>
00140         <span class="keywordflow">for</span> (i = 1 ; i &lt; no ; i++) {
00141             GetOFNFile(strOFNFileNames, i, ts);
00142             SendMessage(lb, LB_ADDSTRING, 0, (LPARAM)ts);
00143         }
00144 
00145     iFileTypeSelected = ofn.nFilterIndex;       <span class="comment">// Get the index of the selected filter.</span>
00146 
00147     BCUpdateButtons(dlg);                       <span class="comment">// Dis/enable buttons.</span>
00148 }
00149 
00150 <span class="keywordtype">void</span> BCConvert(HWND dlg)
00151 <span class="comment">// performs the batch conversion on selected files</span>
00152 <span class="comment">// TODO: progress dialogue, option to cancel process</span>
00153 <span class="comment">//      see SHFileOperation for recycle bin ops, write seperate fn.</span>
00154 {
00155     <span class="keywordtype">int</span>     count;
00156     <span class="keywordtype">int</span>     i, j, iLength;
00157     <span class="keywordtype">char</span>    inBuf[MAX_PATH];
00158     <span class="keywordtype">char</span>    outBuf[MAX_PATH];
00159     <span class="keywordtype">char</span>    statusBuf[MAX_PATH];
00160     <span class="keywordtype">char</span>    FileRoot[MAX_PATH];
00161     <span class="keywordtype">char</span>    FileSuf[4];
00162     <span class="keywordtype">char</span>    fileName[MAX_PATH];
00163     HWND    fl = GetDlgItem(dlg, IDC_BCFILELIST);
00164     HWND    sl = GetDlgItem(dlg, IDC_BCSTATUS);
00165 
00166     LRESULT State;
00167     HANDLE  hFile;
00168     BOOL    bUsingTemp = FALSE;     <span class="comment">// TRUE if using temp directory for intermediate file.</span>
00169     USHORT  dmsError;
00170 <span class="comment">//  char    dmsErrorMessage[MAX_PATH];</span>
00171     BOOL    bOverwriting = TRUE;
00172 
00173     count = SendMessage(fl, LB_GETCOUNT, 0, 0l);
00174     
00175     <span class="keywordflow">for</span> (i = 0 ; i &lt; count ; i++) {
00176         SendMessage(fl, LB_GETTEXT, 0, (LPARAM)&amp;inBuf);     <span class="comment">// Get filename from list.</span>
00177 
00178         UpdateWindow(dlg);
00179 
00180         strcpy(outBuf, inBuf);
00181 
00182         iLength = strlen(inBuf);                        <span class="comment">// Get name length.</span>
00183         <span class="keywordflow">for</span>(j = 0;j &lt; iLength - 3;j++)                  <span class="comment">// Get name root.</span>
00184             FileRoot[j] = inBuf[j];
00185         FileRoot[j] = <span class="charliteral">'\0'</span>;
00186 
00187         FileSuf[0] = inBuf[iLength - 3];                <span class="comment">// Get name suffix.</span>
00188         FileSuf[1] = inBuf[iLength - 2];
00189         FileSuf[2] = inBuf[iLength - 1];
00190         FileSuf[3] = <span class="charliteral">'\0'</span>;
00191         
00192         strcpy(outBuf, FileRoot);                       <span class="comment">// Set the outfile name root.</span>
00193     
00194         <span class="comment">// Get the check state of the ADZ output button.</span>
00195         State = SendMessage(GetDlgItem(dlg, IDC_BCADZ), BM_GETSTATE, 0, 0);
00196         
00197         <span class="comment">// if dms.               </span>
00198         <span class="keywordflow">if</span>(strcmp(FileSuf, <span class="stringliteral">"dms"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"DMS"</span>) == 0 ){
00199             <span class="comment">// Print decompression status message.</span>
00200             sprintf(statusBuf, <span class="stringliteral">"Unpacking file '%s'..."</span>, inBuf);    
00201 
00202             <span class="comment">// If dms to adz, use temp directory.</span>
00203             <span class="keywordflow">if</span>(State &amp; BST_CHECKED){
00204                 _splitpath(strOFNFileNames, NULL, NULL, fileName, NULL);    <span class="comment">// Get filename.</span>
00205                 strcpy(outBuf, dirTemp);
00206                 strcat(outBuf, fileName);
00207                 strcat(outBuf, <span class="stringliteral">"."</span>);
00208                 bUsingTemp = TRUE;                      <span class="comment">// Using temp dir.</span>
00209             }
00210             
00211             strcat(outBuf, <span class="stringliteral">"adf"</span>);                      <span class="comment">// Set the outfile name suffix.</span>
00212             SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);
00213 
00214             <span class="comment">// Check for file overwrite.</span>
00215             hFile = CreateFile(outBuf, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
00216             <span class="comment">// If file exists and we're not writing to temp dir, ask.</span>
00217             <span class="keywordflow">if</span>(hFile != INVALID_HANDLE_VALUE &amp;&amp; !bUsingTemp){
00218                 sprintf(statusBuf, <span class="stringliteral">"The file %s already exists.\n Do you want to overwrite this file?"</span>, outBuf);
00219                 <span class="comment">// Set bool if not overwriting.</span>
00220                 <span class="keywordflow">if</span>(MessageBox(dlg, statusBuf, <span class="stringliteral">"ADF Opus Warning"</span>, MB_YESNO|MB_ICONEXCLAMATION) == IDNO){
00221                     bOverwriting = FALSE;
00222                 }
00223             }
00224 
00225             <span class="keywordflow">if</span>(bOverwriting){
00226             <span class="comment">// Overwrite.</span>
00227                 <span class="keywordflow">if</span>(dmsError = dmsUnpack(inBuf, outBuf) == NO_PROBLEM)   <span class="comment">// Decompress.</span>
00228                     strcpy(statusBuf, <span class="stringliteral">"...file unpacked successfully."</span>);
00229                 <span class="keywordflow">else</span>
00230                     strcpy(statusBuf, <span class="stringliteral">"...error occured during DMS decompression."</span>);
00231             }
00232             <span class="keywordflow">else</span>{
00233                 <span class="comment">// Abort</span>
00234                 strcpy(statusBuf, <span class="stringliteral">"...aborted to avoid overwrite."</span>);
00235 
00236 <span class="comment">// ************************** TRYING TO ACCESS DMS ERRORS IN XDMS.C - WON'T COMPILE</span>
00237 <span class="comment">//              dmsErrMsg(dmsError, inBuf, outBuf, dmsErrorMessage);</span>
00238 <span class="comment">//              strcat(statusBuf, dmsErrorMessage);</span>
00239                 SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);
00240             }
00241         }
00242         
00243 
00244         <span class="comment">//if adz and adf button selected.</span>
00245         <span class="keywordflow">if</span>(strcmp(FileSuf, <span class="stringliteral">"adz"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"ADZ"</span>) == 0 ){
00246             <span class="comment">// Print decompression status message.</span>
00247             sprintf(statusBuf, <span class="stringliteral">"Unpacking file '%s'..."</span>, inBuf);    
00248             strcat(outBuf, <span class="stringliteral">"adf"</span>);                      <span class="comment">// Set the outfile name suffix.</span>
00249             SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);
00250 
00251             <span class="keywordflow">if</span>(GZDecompress(dlg, inBuf, outBuf))
00252                 strcpy(statusBuf, <span class="stringliteral">"...file unpacked successfully."</span>);
00253             <span class="keywordflow">else</span>
00254                 strcpy(statusBuf, <span class="stringliteral">"...failed to unpack file."</span>);
00255         }
00256 
00257         <span class="comment">//if adf or decompressed dms and adz button selected.</span>
00258         <span class="keywordflow">if</span>((strcmp(FileSuf, <span class="stringliteral">"adf"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"ADF"</span>) == 0 )
00259             || ((strcmp(FileSuf, <span class="stringliteral">"dms"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"DMS"</span>) == 0) 
00260             &amp;&amp; (State &amp; BST_CHECKED))){
00261             
00262             <span class="comment">// If recompressing an adf'd dms, remove the suffixes and</span>
00263             <span class="comment">// write last status message.</span>
00264             <span class="keywordflow">if</span>(strcmp(FileSuf, <span class="stringliteral">"dms"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"DMS"</span>) == 0){
00265                 SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);   
00266                 strcpy(inBuf, outBuf);
00267                 strcpy(outBuf, FileRoot);
00268             }
00269 
00270             <span class="comment">// Print compression status message.</span>
00271             sprintf(statusBuf, <span class="stringliteral">"Compressing file '%s'..."</span>, inBuf);  
00272 
00273             strcat(outBuf, <span class="stringliteral">"adz"</span>);                      <span class="comment">// Set the outfile name suffix.</span>
00274             SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);
00275 
00276             <span class="keywordflow">if</span>(GZCompress(dlg, inBuf, outBuf))
00277                 strcpy(statusBuf, <span class="stringliteral">"...file compressed successfully."</span>);
00278             <span class="keywordflow">else</span>
00279                 strcpy(statusBuf, <span class="stringliteral">"...failed to compress file."</span>);
00280 
00281             <span class="comment">// Delete intermediate adf.</span>
00282             <span class="keywordflow">if</span>(strcmp(FileSuf, <span class="stringliteral">"dms"</span>) == 0 || strcmp(FileSuf, <span class="stringliteral">"DMS"</span>) == 0)
00283                 remove(inBuf);
00284         }
00285 
00286         <span class="comment">//no dms compression at this stage.</span>
00287 
00288         SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);       <span class="comment">// Write final status message.</span>
00289         SendMessage(fl, LB_DELETESTRING, 0, 0l);                    <span class="comment">// Delete file from lister. </span>
00290         bUsingTemp = FALSE;                                         <span class="comment">// Reset temp dir flag.</span>
00291 
00292         <span class="keywordflow">if</span>(SendDlgItemMessage(dlg, IDC_BCDELETE_ORIGINAL, BM_GETCHECK, 0, 0L) == BST_CHECKED){
00293         <span class="comment">//Delete the original file.</span>
00294             remove(inBuf);
00295             sprintf(statusBuf, <span class="stringliteral">"Deleted %s."</span>, inBuf);
00296             SendMessage(sl, LB_ADDSTRING, 0, (LPARAM)&amp;statusBuf);   <span class="comment">// Write deletion message.</span>
00297         }
00298     }
00299     <span class="comment">// Write a divider line to improve readability.</span>
00300     SendMessage(sl, LB_ADDSTRING, 0, 
00301         (LPARAM)<span class="stringliteral">"----------------------------------------------------------------------------------------------"</span>);
00302 
00303     <span class="comment">// Re-enable output buttons once operations are complete.</span>
00304     SendMessage(GetDlgItem(dlg, IDC_BCADF), BM_SETCHECK, BST_CHECKED, 0);
00305     SendMessage(GetDlgItem(dlg, IDC_BCADZ), BM_SETCHECK, BST_UNCHECKED, 0);
00306     EnableWindow(GetDlgItem(dlg, IDC_BCADF), TRUE);
00307     EnableWindow(GetDlgItem(dlg, IDC_BCADZ), TRUE);
00308 
00309     BCUpdateButtons(dlg);                       <span class="comment">// Dis/enable buttons.</span>
00310 }
00311 
00312 <span class="keywordtype">void</span> BCUpdateButtons(HWND dlg)
00313 <span class="comment">/* enable/disable relevant list buttons depending on item count and selection</span>
00314 <span class="comment"> */</span>
00315 {
00316     <span class="keywordtype">int</span>     count;
00317 
00318     count = SendMessage(GetDlgItem(dlg, IDC_BCFILELIST), LB_GETCOUNT, 0, 0l);
00319 
00320     EnableWindow(GetDlgItem(dlg, IDC_BCSTART), count);
00321     EnableWindow(GetDlgItem(dlg, IDC_BCREMOVEALL), count);
00322 
00323     count = SendMessage(GetDlgItem(dlg, IDC_BCFILELIST), LB_GETSELCOUNT, 0, 0l);
00324     EnableWindow(GetDlgItem(dlg, IDC_BCREMOVE), count);
00325 
00326     <span class="comment">// If ADFs have been selected, disable the ADF output button</span>
00327     <span class="keywordflow">if</span>(iFileTypeSelected == 1){
00328         <span class="comment">// ADF and ADZ buttons are checkboxes. Uncheck and check.</span>
00329         SendMessage(GetDlgItem(dlg, IDC_BCADF), BM_SETCHECK, BST_UNCHECKED, 0);
00330         SendMessage(GetDlgItem(dlg, IDC_BCADZ), BM_SETCHECK, BST_CHECKED, 0);
00331         EnableWindow(GetDlgItem(dlg, IDC_BCADF), FALSE);
00332     }
00333     <span class="comment">// If ADZs have been selected, disable the ADZ output button.</span>
00334     <span class="keywordflow">if</span>(iFileTypeSelected == 2){
00335         SendMessage(GetDlgItem(dlg, IDC_BCADZ), BM_SETCHECK, BST_UNCHECKED, 0);
00336         SendMessage(GetDlgItem(dlg, IDC_BCADF), BM_SETCHECK, BST_CHECKED, 0);
00337         EnableWindow(GetDlgItem(dlg, IDC_BCADZ), FALSE);
00338     }
00339 
00340 }
00341 
00342 <span class="keywordtype">void</span> BCDeleteSelected(HWND dlg)
00343 {
00344     <span class="keywordtype">int</span> i;
00345     HWND fl = GetDlgItem(dlg, IDC_BCFILELIST);
00346 
00347     <span class="keywordflow">for</span> (i = SendMessage(fl, LB_GETCOUNT, 0, 0l) - 1 ; i &gt;= 0 ; i--)
00348         <span class="keywordflow">if</span> (SendMessage(fl, LB_GETSEL, i, 0l))
00349             SendMessage(fl, LB_DELETESTRING, i, 0l);
00350 
00351     BCUpdateButtons(dlg);
00352 }
00353 
00354 <span class="keywordtype">void</span> BCDeleteAll(HWND dlg)
00355 {
00356     <span class="keywordtype">int</span> i;
00357     HWND fl = GetDlgItem(dlg, IDC_BCFILELIST);
00358 
00359     <span class="keywordflow">for</span> (i = SendMessage(fl, LB_GETCOUNT, 0, 0l) - 1 ; i &gt;= 0 ; i--)
00360         SendMessage(fl, LB_DELETESTRING, i, 0l);
00361 
00362     BCUpdateButtons(dlg);
00363 }
00364 
00365 BOOL GZCompress(HWND win, <span class="keywordtype">char</span> *infile, <span class="keywordtype">char</span> *outfile)
00366 <span class="comment">// Compress an adf with gzip.</span>
00367 <span class="comment">// Input: input file name, output file name, handle to owner window.</span>
00368 <span class="comment">// Send NULL HWND to prevent the overwrite check.</span>
00369 {
00370     <span class="keywordtype">char</span> buf[BUFLEN];
00371     <span class="keywordtype">int</span> len;
00372     FILE *in;
00373     gzFile out;
00374 
00375     <span class="keywordflow">if</span>(win != NULL &amp;&amp; fopen(outfile, <span class="stringliteral">"r"</span>)){
00376         sprintf(buf, <span class="stringliteral">"%s already exists.\n Do you want to overwrite this file?"</span>, outfile);
00377         <span class="keywordflow">if</span>(MessageBox(win, buf, <span class="stringliteral">"ADF Opus Warning"</span>, MB_YESNO|MB_ICONEXCLAMATION) == IDNO)
00378             <span class="keywordflow">return</span> FALSE;
00379     }
00380 
00381     in = fopen(infile, <span class="stringliteral">"rb"</span>);
00382     <span class="keywordflow">if</span> (in == NULL)
00383         <span class="keywordflow">return</span> FALSE;
00384 
00385     out = gzopen(outfile, <span class="stringliteral">"wb9"</span>);
00386     <span class="keywordflow">if</span> (out == NULL)
00387         <span class="keywordflow">return</span> FALSE;
00388 
00389 
00390     <span class="keywordflow">for</span> (;;) {
00391         len = fread(buf, 1, <span class="keyword">sizeof</span>(buf), in);
00392         <span class="keywordflow">if</span> (ferror(in))
00393             <span class="keywordflow">return</span> FALSE;
00394         <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">break</span>;
00395 
00396         <span class="keywordflow">if</span> (gzwrite(out, buf, (<span class="keywordtype">unsigned</span>)len) != len)
00397             <span class="keywordflow">return</span> FALSE;
00398     }
00399     fclose(in);
00400     <span class="keywordflow">if</span> (gzclose(out) != Z_OK)
00401         <span class="keywordflow">return</span> FALSE;
00402 
00403     <span class="keywordflow">return</span> TRUE;
00404 }
00405 
00406 
00407 BOOL GZDecompress(HWND win, <span class="keywordtype">char</span> *infile, <span class="keywordtype">char</span> *outfile)
00408 <span class="comment">// Decompress an adf compressed with gzip.</span>
00409 <span class="comment">// Input: input file name, output file name, handle to owner window.</span>
00410 <span class="comment">// Send NULL HWND to prevent the overwrite check.</span>
00411 {
00412     gzFile  in;
00413     FILE    *out;
00414     <span class="keywordtype">char</span>    buf[BUFLEN];
00415     <span class="keywordtype">int</span>     len;
00416 
00417     <span class="keywordflow">if</span>(win != NULL &amp;&amp; fopen(outfile, <span class="stringliteral">"r"</span>)){
00418         sprintf(buf, <span class="stringliteral">"%s already exists.\n Do you want to overwrite this file?"</span>, outfile);
00419         <span class="keywordflow">if</span>(MessageBox(win, buf, <span class="stringliteral">"ADF Opus Warning"</span>, MB_YESNO|MB_ICONEXCLAMATION) == IDNO)
00420             <span class="keywordflow">return</span> FALSE;
00421     }
00422 
00423     out = fopen(outfile, <span class="stringliteral">"wb"</span>);
00424     <span class="keywordflow">if</span>(out == NULL)
00425         <span class="keywordflow">return</span> FALSE;
00426 
00427     in = gzopen(infile, <span class="stringliteral">"rb"</span>);
00428     <span class="keywordflow">if</span>(in == NULL)
00429         <span class="keywordflow">return</span> FALSE;
00430 
00431     <span class="keywordflow">for</span>(;;){
00432         len = gzread(in, buf, <span class="keyword">sizeof</span>(buf));
00433         <span class="keywordflow">if</span>(len &lt; 0)
00434             <span class="keywordflow">return</span> FALSE;
00435         <span class="keywordflow">if</span>(len == 0) 
00436             <span class="keywordflow">break</span>;
00437         <span class="keywordflow">if</span>((int)fwrite(buf, 1, (<span class="keywordtype">unsigned</span>)len, out) != len)
00438             <span class="keywordflow">return</span> FALSE;
00439     }
00440     <span class="keywordflow">if</span>(fclose(out)) 
00441         <span class="keywordflow">return</span> FALSE;
00442 
00443     <span class="keywordflow">if</span>(gzclose(in) != Z_OK) 
00444         <span class="keywordflow">return</span> FALSE;
00445 
00446     <span class="keywordflow">return</span> TRUE;
00447 }
00448 
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:39 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
