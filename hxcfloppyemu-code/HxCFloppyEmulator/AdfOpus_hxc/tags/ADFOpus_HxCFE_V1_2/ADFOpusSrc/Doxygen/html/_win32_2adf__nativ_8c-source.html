<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>adf_nativ.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>adf_nativ.c</h1><a href="_win32_2adf__nativ_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00011 <span class="preprocessor">#include &lt;windows.h&gt;</span>
00012 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00013 <span class="preprocessor">#include &lt;string.h&gt;</span>
00014 
00015 <span class="preprocessor">#include "../adf_str.h"</span>
00016 <span class="preprocessor">#include "../adf_err.h"</span>
00017 
00018 <span class="preprocessor">#include "adf_nativ.h"</span>
00019 <span class="preprocessor">#include "nt4_dev.h"</span>
00020 
00021 <span class="keyword">extern</span> <span class="keyword">struct </span>Env adfEnv;
00022 
00023 RETCODE Win32InitDevice(<span class="keyword">struct</span> Device* dev, <span class="keywordtype">char</span>* lpstrName, BOOL ro)
00024 {
00025     <span class="keyword">struct </span>nativeDevice* nDev;
00026     <span class="keywordtype">char</span> strTempName[3];
00027 
00028     nDev = (<span class="keyword">struct </span>nativeDevice*)dev-&gt;nativeDev;
00029 
00030     nDev = (<span class="keyword">struct </span>nativeDevice*)malloc(sizeof(struct nativeDevice));
00031     <span class="keywordflow">if</span> (!nDev) {
00032         (*adfEnv.eFct)(<span class="stringliteral">"Win32InitDevice : malloc"</span>);
00033         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00034     }
00035 
00036     <span class="comment">/* convert device name to something usable by Win32 functions */</span>
00037     <span class="keywordflow">if</span> (strlen(lpstrName) != 3) {
00038         (*adfEnv.eFct)(<span class="stringliteral">"Win32InitDevice : invalid drive specifier"</span>);
00039         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00040     }
00041 
00042     strTempName[0] = lpstrName[1];
00043     strTempName[1] = lpstrName[2];
00044     strTempName[2] = <span class="charliteral">'\0'</span>;
00045 
00046     nDev-&gt;hDrv = NT4OpenDrive(strTempName);
00047 
00048     <span class="keywordflow">if</span> (nDev-&gt;hDrv == NULL) {
00049         (*adfEnv.eFct)(<span class="stringliteral">"Win32InitDevice : NT4OpenDrive"</span>);
00050         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00051     }
00052 
00053     dev-&gt;size = NT4GetDriveSize(nDev-&gt;hDrv);
00054 
00055     dev-&gt;nativeDev = nDev;
00056 
00057     <span class="keywordflow">return</span> RC_OK;
00058 }
00059 
00060 
00061 RETCODE Win32ReadSector(<span class="keyword">struct</span> Device *dev, <span class="keywordtype">long</span> n, <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf)
00062 {
00063     <span class="keyword">struct </span>nativeDevice* tDev;
00064 
00065     tDev = (<span class="keyword">struct </span>nativeDevice*)dev-&gt;nativeDev;
00066 
00067     <span class="keywordflow">if</span> (! NT4ReadSector(tDev-&gt;hDrv, n, size, buf)) {
00068         (*adfEnv.eFct)(<span class="stringliteral">"Win32InitDevice : NT4ReadSector"</span>);
00069         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00070     }
00071 
00072     <span class="keywordflow">return</span> RC_OK;
00073 }
00074 
00075 
00076 RETCODE Win32WriteSector(<span class="keyword">struct</span> Device *dev, <span class="keywordtype">long</span> n, <span class="keywordtype">int</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf)
00077 {
00078     <span class="keyword">struct </span>nativeDevice* tDev;
00079 
00080     tDev = (<span class="keyword">struct </span>nativeDevice*)dev-&gt;nativeDev;
00081 
00082     <span class="keywordflow">if</span> (! NT4WriteSector(tDev-&gt;hDrv, n, size, buf)) {
00083         (*adfEnv.eFct)(<span class="stringliteral">"Win32InitDevice : NT4WriteSector"</span>);
00084         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00085     }
00086 
00087     <span class="keywordflow">return</span> RC_OK;
00088 }
00089 
00090 
00091 RETCODE Win32ReleaseDevice(<span class="keyword">struct</span> Device *dev)
00092 {
00093     <span class="keyword">struct </span>nativeDevice* nDev;
00094 
00095     nDev = (<span class="keyword">struct </span>nativeDevice*)dev-&gt;nativeDev;
00096 
00097     <span class="keywordflow">if</span> (! NT4CloseDrive(nDev-&gt;hDrv))
00098         <span class="keywordflow">return</span> RC_ERROR;                                                    <span class="comment">/* BV */</span>
00099 
00100     free(nDev);
00101 
00102     <span class="keywordflow">return</span> RC_OK;
00103 }
00104 
00105 
00106 <span class="keywordtype">void</span> adfInitNativeFct()
00107 {
00108     <span class="keyword">struct </span>nativeFunctions *nFct;
00109 
00110     nFct = (<span class="keyword">struct </span>nativeFunctions*)adfEnv.nativeFct;
00111 
00112     nFct-&gt;adfInitDevice = Win32InitDevice;
00113     nFct-&gt;adfNativeReadSector = Win32ReadSector;
00114     nFct-&gt;adfNativeWriteSector = Win32WriteSector;
00115     nFct-&gt;adfReleaseDevice = Win32ReleaseDevice;
00116     nFct-&gt;adfIsDevNative = Win32IsDevNative;
00117 }
00118 
00119 
00120 BOOL Win32IsDevNative(<span class="keywordtype">char</span> *devName)
00121 {
00122     <span class="keywordflow">return</span> devName[0] == <span class="charliteral">'|'</span>;
00123 }
</pre></div><hr><address style="align: right;"><small>Generated on Tue Nov 5 12:21:38 2002 for dynlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.18 </small></address>
</body>
</html>
